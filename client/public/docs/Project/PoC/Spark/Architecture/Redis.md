# Redis

## 개요

### Redis란?

인메모리 데이터 저장소로, 빠른 속도의 키-값 데이터베이스입니다.

주로 캐싱, 세션 저장, 실시간 데이터 처리용으로 많이 사용됩니다.

다양한 데이터 구조(문자열, 해시, 리스트, 셋, 정렬된 셋 등)를 지원하며, 높은 처리량과 낮은 지연 시간을 제공합니다.

분산 환경에서도 쉽게 확장 가능하며 데이터 영속성 옵션도 선택적으로 제공합니다.

### Pub/Sub (Publish/Subscribe)

메시지 전달 패턴 중 하나로, 발행자(Publisher)가 메시지를 특정 주제(Topic/Channel)에 발행하면, 구독자(Subscriber)들이 해당 주제의 메시지를 실시간으로 받아보는 구조입니다.

Pub/Sub는 이벤트 기반 아키텍처에서 서비스 간 메시지 전달을 비동기적으로 수행하는 데 효과적입니다.

Redis는 자체적으로 Pub/Sub 기능을 내장해 간단한 메시징 시스템 구축에 활용할 수 있습니다.

Pub/Sub는 메시지 브로커(예: Kafka, RabbitMQ)에서도 많이 쓰이며, 시스템 간 loose coupling(약한 결합)과 확장성을 제공합니다.

### 요약

-   Redis는 빠른 데이터 처리를 위한 인메모리 데이터베이스입니다.
-   Pub/Sub는 발행-구독 메시지를 전달하는 메시징 패턴입니다.
-   Redis 내부에도 Pub/Sub 기능이 있어 간단한 실시간 메시징 구현이 가능합니다.
-   이 두 가지를 조합해 MSA 환경에서 빠른 캐싱과 실시간 통신/이벤트 처리에 활용할 수 있습니다.

## Redis를 별도 서버로 띄우는 이유

Redis는 이 프로젝트에서 캐시와 실시간 메시징을 위한 핵심 구성 요소로 사용되며, 별도의 서버로 실행해야 합니다.

### Redis가 적용된 MVP

이 프로젝트의 MVP(최소 기능 제품)에서는 Redis를 캐시 서버로 사용해 API Gateway의 성능을 높이고, Socket.IO를 통해 실시간 메시징 기능을 구현합니다.

Redis는 주로 API Gateway의 인증 토큰, Rate Limiting 정보, 실시간 메시지 상태 등을 저장하고 관리합니다.

### Redis를 적용하는 이유

1. **성능 향상**: 자주 접근하는 데이터(예: API Key, JWT 토큰, Rate Limiting 정보)를 Redis에 캐시하여 데이터베이스 부하를 줄이고 응답 속도를 빠르게 합니다.

2. **실시간 메시징**: Socket.IO와 Redis Adapter를 함께 사용해 여러 서버 인스턴스 간 실시간 메시지를 공유할 수 있습니다. 이를 통해 확장성 있는 실시간 채팅, 알림 등 기능을 구현할 수 있습니다.

3. **분산 시스템 지원**: 여러 서버에서 동작하는 API Gateway가 Redis를 통해 상태를 공유할 수 있어, 세션, 인증, Rate Limiting 등의 상태를 일관성 있게 관리할 수 있습니다.

따라서 서버 실행 시 별도로 Redis 서버를 띄워야 하며, `.env` 파일에 Redis 호스트와 포트 정보를 설정해 주어야 합니다.

## Redis 캐싱 업데이트 성능 저하 이슈

Redis 캐싱 업데이트가 오래 걸리는 문제는 주로 다음 이유들로 발생합니다.

### 원인

1. **동시 업데이트 동기화 비용**: Redis는 메모리 기반이라 데이터 조회 속도는 매우 빠르지만, 캐시가 자주 변경되는 데이터에 대해 동시에 업데이트가 발생하면 동기화 비용이 발생해 성능 저하가 생길 수 있습니다.

2. **캐시 무효화 문제**: 데이터베이스와 캐시 간의 동기화 문제도 영향을 줘, 갱신 시점에 API 서버가 여러 대면 캐시 서버에 일관된 업데이트가 복잡해져 지연이 생길 수 있습니다.

3. **초기 로딩 시간**: 첫 캐시 적중 전, 즉 캐시가 비어있거나 만료된 상태에서 DB에서 데이터를 불러오고 캐시에 저장하는 초기 로딩 시간이 오래 걸릴 수 있습니다.

### 해결 및 최적화 방법

1. **비동기 업데이트**: 비동기 업데이트를 도입해 쓰기 작업의 병목을 줄이고, 데이터베이스가 먼저 업데이트되고 이후 캐시가 갱신되도록 설계(Write-Through 캐싱 패턴)하는 방법이 있습니다.

2. **TTL(Time to Live) 설정**: TTL 설정으로 캐시 무효화를 자동화하여 데이터 불일치를 방지하고, 캐시 적중률을 높이는 전략을 취합니다.

3. **분산 락**: 캐시 갱신 시 동시성 문제를 줄이기 위해 분산 락이나 선점적 갱신 전략을 도입하기도 합니다.

4. **클러스터링 및 복제**: 네트워크 비용 최적화 및 캐시 서버 클러스터링, 복제 등을 통한 가용성 향상도 고려할 수 있습니다.

간단히 말해, Redis는 읽기 성능은 매우 뛰어나지만, 캐시 업데이트 시점이나 잦은 쓰기 작업에서는 설계와 운영 전략에 따라 성능 저하가 있을 수 있으며 이를 비동기 처리, TTL, 락 관리 등으로 보완합니다.

## 내부망에 Socket.IO 서버, API Gateway, Redis가 필요한 이유

내부망에 보통 Socket.IO 서버, API Gateway, Redis 3가지가 함께 있어야 합니다.

-   **Socket.IO 서버**: 실시간 양방향 통신을 처리하며, 클라이언트와 실시간 메시징 및 이벤트를 주고받는 역할을 합니다.

-   **API Gateway**: 클라이언트 요청을 받아 적절한 서비스로 라우팅하며 인증, 권한, Rate Limiting 같은 공통 기능을 담당합니다.

-   **Redis**: 캐싱과 메시지 브로커 역할을 하며, Socket.IO의 경우 여러 서버 인스턴스 간 메시지 상태를 공유하는 데 Redis Adapter를 사용합니다. 또한 API Gateway에서는 인증 토큰이나 Rate Limiting 데이터를 빠르게 조회하기 위한 캐시 서버 역할을 합니다.

이 세 구성 요소가 함께 작동하면서 실시간 통신과 API 요청 처리의 성능과 확장성을 높입니다.

## Socket.IO 서버, API Gateway, Redis 간 데이터 흐름

### 데이터 흐름 예시

1. 클라이언트가 API Gateway에 인증 요청 또는 데이터 요청을 보냅니다.

2. API Gateway는 Redis에서 인증 토큰이나 Rate Limiting 정보를 조회하여 검사합니다.

3. 인증이 정상이라면 API Gateway는 실제 서비스(예: 데이터베이스 또는 비즈니스 로직)와 통신 후 결과를 클라이언트에 응답합니다.

4. 클라이언트가 실시간 메시징을 위해 Socket.IO 서버에 연결해 메시지를 보냅니다.

5. Socket.IO 서버는 받은 메시지를 Redis Pub/Sub 또는 Redis Adapter를 통해 여러 Socket.IO 인스턴스에 전달하여 메시지를 여러 클라이언트에게 실시간으로 뿌립니다.

6. Redis는 캐시와 메시지 중계 역할을 하며, 각 서버가 동기화 상태를 유지하는 데 사용됩니다.

### 아키텍처 다이어그램

```
Client
│
▼ 인증/요청 데이터

API Gateway ── 인증/Rate Limiting 조회 ──▶ Redis (캐시)
│ ▲
│ │
▼ │
서비스(예: DB) ◀───────────── 처리 결과

Client ── 실시간 메시지 ──▶ Socket.IO 서버 ── Pub/Sub ──▶ Redis (메시지 중계)
│
다른 Socket.IO 서버
│
Broadcast to Clients
```

### 요약

-   API Gateway는 Redis에서 인증과 Rate Limiting 정보를 빠르게 조회합니다.
-   Socket.IO는 Redis를 통해 여러 서버 인스턴스 간 실시간 메시지를 공유합니다.
-   이처럼 Redis가 중앙 캐시 및 메시지 브로커 역할을 하면서 API Gateway와 Socket.IO 서버 간 데이터를 원활하게 주고받는 구조입니다.
-   여러 애플리케이션 서버(예: Socket.IO 서버 인스턴스)들이 Redis에 구독자로 연결되어 있다가 메시지를 받아 처리하는 구조입니다.
-   따라서 Redis 서버는 캐시 서버 역할과 함께 Pub/Sub 중계 서버 역할을 동시에 수행합니다.

---

## Redis 서버 MVP 문서

### 목표

-   API Gateway와 Socket.IO 서버에 캐싱 및 실시간 메시지 중계 기능을 제공하는 Redis 서버를 구축합니다.
-   빠른 인증 토큰, Rate Limiting 정보 조회와 실시간 메시징을 지원합니다.
-   내부망에서 안정적이고 확장 가능하게 동작하도록 합니다.

### 주요 기능

#### 1. 캐시 기능

-   API Gateway에서 JWT 토큰, API Key, Rate Limiting 데이터 등을 저장하고 조회할 수 있는 캐시 제공
-   TTL(Time to Live) 설정으로 데이터 자동 만료 및 무효화 지원
-   캐시 갱신 시 성능 저하 방지를 위한 비동기 쓰기, 갱신 전략 구현

#### 2. Pub/Sub 메시지 중계

-   Socket.IO 서버 등 다중 인스턴스 간 실시간 메시지 전달을 위한 Pub/Sub 지원
-   채팅 메시지, 알림, 시스템 이벤트 등을 Redis Pub/Sub 채널을 통해 중계
-   구독자(Subscriber) 관리 및 메시지 전달 안정성 보장

#### 3. 보안 및 접근 제어

-   Redis 연결 시 보안 설정(비밀번호, 인증 등)
-   내부망 전용 접근 및 권한 관리(방화벽, 네트워크 정책)

#### 4. 개발 환경 및 배포

-   Redis 버전: 6.x 이상 권장
-   환경 변수로 Redis 포트, 비밀번호, 호스트 설정 가능
-   Docker 컨테이너 배포 지원 권장

### API Gateway 연동 방식

-   Redis 캐시에서 인증 토큰, Rate Limiting 정보를 읽고 쓰는 REST API 또는 client 라이브러리 활용
-   캐시 미스 시 DB 조회 후 캐시 저장, TTL 적용
-   비동기 갱신 전략으로 캐시 부하 감소

### Socket.IO 서버 연동 방식

-   Redis Adapter를 사용해 여러 Socket.IO 서버 인스턴스들이 Pub/Sub 채널을 통해 메시지 전달
-   각 서버는 Redis Pub/Sub을 구독해 실시간 데이터 수신

### 개발 일정 (예시)

| 단계                            | 주요 작업                                   | 기간(예상) |
| ------------------------------- | ------------------------------------------- | ---------- |
| 1. 요구사항 분석                | 기능 정의, 환경 설정                        | -          |
| 2. Redis 서버 설치 및 기본 설정 | Redis 설치, 보안 설정 적용                  | -          |
| 3. 캐시 기능 구현               | TTL 설정, 캐시 읽기/쓰기 API 구현           | -          |
| 4. Pub/Sub 기능 구현            | Pub/Sub 채널 구현, 테스트                   | -          |
| 5. 연동 테스트                  | API Gateway 및 Socket.IO 서버와 연동 테스트 | -          |
| 6. 문서화 및 배포               | 운영 문서 작성, Docker 이미지 및 배포       | -          |

### 추가 고려 사항

-   고가용성을 위한 Redis Sentinel 또는 클러스터링 고려
-   장애 대응 및 모니터링 시스템 구축
-   데이터 일관성 및 동시성 제어 전략
