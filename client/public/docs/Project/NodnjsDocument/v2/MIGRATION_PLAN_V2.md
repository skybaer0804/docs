# Node.js Document Project v2 ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

## 1. ê°œìš” (Overview)

ë³¸ ë¬¸ì„œëŠ” ê¸°ì¡´ ì •ì  íŒŒì¼ ê¸°ë°˜ì˜ ë¬¸ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œì„ **Express.js + PostgreSQL (Supabase)** ê¸°ë°˜ì˜ ë™ì  í’€ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì „í™˜í•˜ê¸° ìœ„í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íšì„ ê¸°ìˆ í•©ë‹ˆë‹¤.

### ì£¼ìš” ëª©í‘œ

- **DB ê¸°ë°˜ ê´€ë¦¬**: íŒŒì¼ ì‹œìŠ¤í…œ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³  DBë¥¼ í†µí•´ ë¬¸ì„œì™€ í´ë” êµ¬ì¡°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
- **ì‚¬ìš©ì ì¸ì¦**: JWT ê¸°ë°˜ ë¡œê·¸ì¸ì„ ë„ì…í•˜ì—¬ ë¬¸ì„œ ì‘ì„± ê¶Œí•œì„ ê´€ë¦¬í•©ë‹ˆë‹¤. (ë¹„ë¡œê·¸ì¸: ì¡°íšŒë§Œ ê°€ëŠ¥)
- **SPA ë¼ìš°íŒ… í•´ê²°**: Express ì„œë²„ë¥¼ í†µí•´ SPA ìƒˆë¡œê³ ì¹¨ ì‹œ ë°œìƒí•˜ëŠ” 404/CSS ê¹¨ì§ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
- **ë¬´ë£Œ ë°°í¬ ìµœì í™”**: Koyeb ë° Supabase ë¬´ë£Œ í‹°ì–´ë¥¼ í™œìš©í•œ ì§€ì† ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

---

## 2. ì•„í‚¤í…ì²˜ (Architecture)

### 2.1 ì „ì²´ êµ¬ì¡°

ë‹¨ì¼ ë ˆí¬ì§€í† ë¦¬(Monorepo) ë‚´ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ë¥¼ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤.

```mermaid
graph TD
    Client[Client (React/Vite)] -->|API Request| Server[Server (Express)]
    Server -->|Query| DB[(Supabase PostgreSQL)]
    Browser[User Browser] -->|Load Static Files| Server
```

### 2.2 ê¸°ìˆ  ìŠ¤íƒ

- **Frontend**: React/Preact (ê¸°ì¡´ ìœ ì§€), Vite
- **Backend**: Node.js, Express.js
- **Database**: PostgreSQL (Supabase Hosting)
- **Deployment**: Koyeb (PaaS)

---

## 3. ë””ë ‰í† ë¦¬ êµ¬ì¡° (Directory Structure)

### 3.1 ë³€ê²½ ì „ (AS-IS)

```
project-root/
â”œâ”€â”€ src/           # í”„ë¡ íŠ¸ì—”ë“œ ì†ŒìŠ¤
â”œâ”€â”€ public/        # ì •ì  íŒŒì¼
â”œâ”€â”€ package.json
â””â”€â”€ vite.config.js
```

### 3.2 ë³€ê²½ í›„ (TO-BE)

```
project-root/
â”œâ”€â”€ client/                 # (êµ¬) í˜„ì¬ í”„ë¡œì íŠ¸ ì†ŒìŠ¤ ì´ë™
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ vite.config.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ server/                 # ì‹ ê·œ Express ì„œë²„
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/         # DB ì—°ê²° ë“± ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ controllers/    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ routes/         # API ë¼ìš°í„°
â”‚   â”‚   â”œâ”€â”€ middleware/     # ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
â”‚   â”‚   â””â”€â”€ app.js          # ì•± ì§„ì…ì 
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ .env                # í™˜ê²½ ë³€ìˆ˜
â”œâ”€â”€ package.json            # ì „ì²´ ë¹Œë“œ/ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê´€ë¦¬
â””â”€â”€ koyeb.yaml              # ë°°í¬ ì„¤ì •
```

---

## 4. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (Database Schema)

Supabase PostgreSQLì„ ì‚¬ìš©í•˜ë©°, íŒŒì¼ ì‹œìŠ¤í…œì„ DBë¡œ ì˜®ê¸°ê¸° ìœ„í•´ **ì¸ì ‘ ëª©ë¡(Adjacency List)** íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 4.1 Users í…Œì´ë¸” (ì‚¬ìš©ì)

ë¡œê·¸ì¸ ë° ê¶Œí•œ ê´€ë¦¬ë¥¼ ìœ„í•œ í…Œì´ë¸”ì…ë‹ˆë‹¤.

```sql
CREATE TABLE users (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  username text UNIQUE NOT NULL,
  password_hash text NOT NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
```

### 4.2 Nodes í…Œì´ë¸” (íŒŒì¼ ì‹œìŠ¤í…œ í†µí•©)

í´ë”ì™€ íŒŒì¼ì„ í†µí•© ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤. íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ í‘œí˜„í•©ë‹ˆë‹¤.

```sql
CREATE TYPE node_type AS ENUM ('FILE', 'DIRECTORY');

CREATE TABLE nodes (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  parent_id uuid REFERENCES nodes(id) ON DELETE CASCADE, -- ìƒìœ„ í´ë” ID (RootëŠ” NULL)
  type node_type NOT NULL,                               -- íƒ€ì…: íŒŒì¼ ë˜ëŠ” í´ë”
  name text NOT NULL,                                    -- ì´ë¦„ (ì˜ˆ: "guide.md")
  content text,                                          -- ë‚´ìš© (íŒŒì¼ì¸ ê²½ìš° Markdown ë³¸ë¬¸)
  path text UNIQUE NOT NULL,                             -- ì „ì²´ ê²½ë¡œ (ì˜ˆ: "/docs/api/intro")
  is_public boolean DEFAULT true,                        -- ê³µê°œ ì—¬ë¶€
  author_id uuid REFERENCES users(id),                   -- ì‘ì„±ì
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,

  -- ê°™ì€ í´ë” ë‚´ ì´ë¦„ ì¤‘ë³µ ë°©ì§€
  UNIQUE(parent_id, name)
);

-- ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_nodes_parent_id ON nodes(parent_id);
CREATE INDEX idx_nodes_path ON nodes(path);
```

---

## 5. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Business Logic)

### 5.1 ì¸ì¦ (Authentication)

- **ë¡œê·¸ì¸**: Supabase Auth ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ì§ì ‘ êµ¬í˜„ ì‹œ Supabaseê°€ ë°œê¸‰í•œ JWT Secretì„ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ê²€ì¦í•©ë‹ˆë‹¤.
- **ë¯¸ë“¤ì›¨ì–´**: API ìš”ì²­ í—¤ë”(`Authorization: Bearer <token>`)ì— í¬í•¨ëœ í† í°ì„ Supabaseì˜ JWT Secretìœ¼ë¡œ ê²€ì¦í•˜ì—¬ ì‚¬ìš©ì ì‹ ì›ì„ í™•ì¸í•©ë‹ˆë‹¤.

### 5.2 ë¼ìš°íŒ… ë° SPA Fallback (ìƒˆë¡œê³ ì¹¨ ë¬¸ì œ í•´ê²°)

Express ì„œë²„ê°€ ì •ì  íŒŒì¼ ì„œë¹™ê³¼ API ì²˜ë¦¬ë¥¼ ë™ì‹œì— ë‹´ë‹¹í•©ë‹ˆë‹¤.

```javascript
// server/src/app.js ì˜ˆì‹œ

// 1. API ìš”ì²­ ì²˜ë¦¬
app.use('/api', apiRouter);

// 2. ì •ì  íŒŒì¼(Frontend Build) ì„œë¹™
app.use(express.static(path.join(__dirname, '../../client/dist')));

// 3. ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ì€ index.html ë°˜í™˜ (SPA ë¼ìš°íŒ… ì§€ì›)
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../../client/dist/index.html'));
});
```

### 5.3 ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ê´€ë¦¬ (RESTful API)

ë¬¸ì„œ ë° ë””ë ‰í† ë¦¬ì— ëŒ€í•œ ëª¨ë“  ì‘ì—…ì€ RESTful APIë¥¼ ë”°ë¦…ë‹ˆë‹¤.

|   Method   | Endpoint             | ì„¤ëª…                            |   ê¶Œí•œ    | Request Body / Query                              |
| :--------: | :------------------- | :------------------------------ | :-------: | :------------------------------------------------ |
|  **GET**   | `/api/docs`          | ì „ì²´ ë¬¸ì„œ/í´ë” êµ¬ì¡° ì¡°íšŒ (íŠ¸ë¦¬) |   ì „ì²´    | -                                                 |
|  **GET**   | `/api/docs/:path(*)` | íŠ¹ì • ë¬¸ì„œ ë‚´ìš© ì¡°íšŒ             |   ì „ì²´    | -                                                 |
|  **POST**  | `/api/docs`          | ìƒˆ ë¬¸ì„œ ë˜ëŠ” í´ë” ìƒì„±          | ğŸ” ë¡œê·¸ì¸ | `{ type, parent_path, name, content, is_public }` |
|  **PUT**   | `/api/docs/:id`      | ë¬¸ì„œ ìˆ˜ì • (ë‚´ìš©, ê³µê°œì—¬ë¶€ ë“±)   | ğŸ” ë¡œê·¸ì¸ | `{ content, is_public, name }`                    |
| **DELETE** | `/api/docs/:id`      | ë¬¸ì„œ ë˜ëŠ” í´ë” ì‚­ì œ             | ğŸ” ë¡œê·¸ì¸ | -                                                 |
|  **POST**  | `/api/docs/upload`   | .md íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ            | ğŸ” ë¡œê·¸ì¸ | `multipart/form-data` (file)                      |

> **ê¶Œí•œ ì •ì±… (2ì°¨ ë°˜ì˜)**  
> ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” â€œëª¨ë“  ë¬¸ì„œâ€ê°€ ì•„ë‹ˆë¼ **ë³¸ì¸ì´ ìƒì„±(author_id)í•œ ë…¸ë“œë§Œ** ìƒì„±/ìˆ˜ì •/ì‚­ì œ/ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì¡°íšŒëŠ” ê³µê°œ ì •ì±…ì— ë”°ë¼ ë³„ë„)

#### ìƒì„¸ ë¡œì§

1.  **ë¬¸ì„œ ì¡°íšŒ (`GET /api/docs/:path(*)`)**
    - URL ê²½ë¡œ(ì˜ˆ: `/docs/api/guide`)ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ DBì˜ `path` ì»¬ëŸ¼ê³¼ ë§¤ì¹­í•©ë‹ˆë‹¤.
    - **ê¶Œí•œ ì²´í¬**:
      - ë¡œê·¸ì¸ ì‚¬ìš©ì: ëª¨ë“  ë¬¸ì„œ ì¡°íšŒ ê°€ëŠ¥. (ê³µê°œ/ë¹„ê³µê°œ ì •ì±…ì€ ì„œë¹„ìŠ¤ ì •ì±…ì— ë”°ë¼ ì¡°ì •)
      - ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: `is_public = true`ì¸ ë¬¸ì„œë§Œ ì¡°íšŒ ê°€ëŠ¥. `false`ì¸ ê²½ìš° 403 Forbidden ë˜ëŠ” 404 Not Found ë°˜í™˜.
2.  **ë¬¸ì„œ ìƒì„± (`POST /api/docs`)**

    - **Input**:
      - `type`: 'FILE' | 'DIRECTORY'
      - `parent_path`: ìƒìœ„ í´ë” ê²½ë¡œ (ì˜ˆ: `/docs/api`)
      - `name`: íŒŒì¼ëª… (ì˜ˆ: `intro`)
      - `content`: ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ (FILEì¼ ê²½ìš°)
      - `is_public`: ê³µê°œ ì—¬ë¶€ (ê¸°ë³¸ê°’ true)
    - **Logic**:
      - `parent_path`ë¡œ ë¶€ëª¨ ë…¸ë“œì˜ IDë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      - ë¶€ëª¨ ì•„ë˜ì— ì¤‘ë³µëœ `name`ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
      - ì „ì²´ `path`ë¥¼ ìƒì„±í•˜ê³  DBì— ì €ì¥í•©ë‹ˆë‹¤.

3.  **ë¬¸ì„œ ìˆ˜ì • (`PUT /api/docs/:id`)**

    - **Input**: `content` (ìˆ˜ì •ëœ ë³¸ë¬¸), `is_public` (ê³µê°œ ì„¤ì • ë³€ê²½), `name` (ì´ë¦„ ë³€ê²½ ì‹œ)
    - **Logic**:
      - IDë¡œ ë¬¸ì„œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      - `is_public` ë³€ê²½ ìš”ì²­ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤ (ë¹„ê³µê°œ â†” ì „ì²´ê³µê°œ ì „í™˜).
      - ì´ë¦„ ë³€ê²½ ì‹œ ê°™ì€ í´ë” ë‚´ ì¤‘ë³µ ì²´í¬ ë° `path` ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
      - `updated_at` íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.

4.  **íŒŒì¼ ì—…ë¡œë“œ (`POST /api/docs/upload`)**
    - **ê¸°ëŠ¥**: ê¸°ì¡´ì— ì‘ì„±ëœ `.md` íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì—¬ ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    - **Logic**:
      - `multer` ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë²„í¼ë¥¼ ì½ìŠµë‹ˆë‹¤.
      - íŒŒì¼ ë‚´ìš©ì„ í…ìŠ¤íŠ¸(`utf-8`)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
      - íŒŒì¼ëª…(`filename.md`)ì—ì„œ í™•ì¥ìë¥¼ ì œê±°í•˜ì—¬ `name`ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - ì´í›„ ë¡œì§ì€ **ë¬¸ì„œ ìƒì„±**ê³¼ ë™ì¼í•˜ê²Œ DBì— ì €ì¥í•©ë‹ˆë‹¤ (`type='FILE'`, `content=íŒŒì¼ë‚´ìš©`).

---

## 6. ë°°í¬ ì „ëµ (Deployment)

**Koyeb**ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬í•˜ë©°, ë£¨íŠ¸ì˜ `package.json`ì„ í†µí•´ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ ìë™í™”í•©ë‹ˆë‹¤.

### 6.1 ë£¨íŠ¸ package.json ìŠ¤í¬ë¦½íŠ¸

```json
{
  "scripts": {
    "postinstall": "cd client && npm install && cd ../server && npm install",
    "build": "cd client && npm run build",
    "start": "cd server && node src/app.js"
  }
}
```

### 6.2 ë°°í¬ í”„ë¡œì„¸ìŠ¤

1. GitHub ë ˆí¬ì§€í† ë¦¬ì— ì½”ë“œ í‘¸ì‹œ.
2. Koyebì´ ë³€ê²½ ì‚¬í•­ ê°ì§€.
3. `npm install` (ë£¨íŠ¸ -> í´ë¼ì´ì–¸íŠ¸ -> ì„œë²„).
4. `npm run build` (í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ -> `client/dist` ìƒì„±).
5. `npm start` (ì„œë²„ ì‹¤í–‰ -> `client/dist` ì„œë¹™).

---

## 7. ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ (Migration Steps)

1. **Step 1: êµ¬ì¡° ë³€ê²½**
   - `client` í´ë” ìƒì„± ë° ê¸°ì¡´ ì†ŒìŠ¤ ì´ë™.
   - `server` í´ë” ìƒì„± ë° Express ì´ˆê¸°í™”.
2. **Step 2: DB êµ¬ì¶•**
   - Supabase í”„ë¡œì íŠ¸ ìƒì„±.
   - SQL Editorë¥¼ í†µí•´ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì ìš©.
3. **Step 3: ë°±ì—”ë“œ ê°œë°œ**
   - DB ì—°ê²° ì„¤ì •.
   - ì¸ì¦ ë° CRUD API êµ¬í˜„.
4. **Step 4: í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™**
   - API í˜¸ì¶œ ë¡œì§ êµ¬í˜„.
   - ë¹Œë“œ ì„¤ì • ìˆ˜ì •.
5. **Step 5: ë°°í¬**
   - Koyeb ì—°ê²° ë° ë°°í¬ í…ŒìŠ¤íŠ¸.

---

## 8. ë§ˆì´ê·¸ë ˆì´ì…˜ 2ì°¨ (Phase 2) â€” UX ì¬êµ¬ì„± + ìºì‹± + DnD(ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)

> **ëª©í‘œ**: â€œë¬¸ì„œ íƒìƒ‰/ì •ë¦¬â€ ê²½í—˜ì„ 1ë‹¨ê³„ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤.  
> **í•µì‹¬ ë²”ìœ„**: Breadcrumb ë¶„ë¦¬/ìŠ¤í‹°í‚¤, Layout ë†’ì´/ìŠ¤í¬ë¡¤ ì •ë¦¬, TanStack Query ì „í™˜(ìºì‹±), ì½˜í…ì¸  í´ë” â‹¯ ë©”ë‰´(ì‚­ì œ), ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë™(ì½˜í…ì¸ +ì‚¬ì´ë“œë°”) + ë°±ì—”ë“œ move API + ì• ë‹ˆë©”ì´ì…˜.

### 8.1 2ì°¨ ê²°ì •ì‚¬í•­(ë¶ˆë³€ ì¡°ê±´)

- **ê¶Œí•œ ì •ì±…**: ìƒì„±/ìˆ˜ì •/ì‚­ì œ/ì´ë™ì€ **ë³¸ì¸(author_id)ë§Œ ê°€ëŠ¥**
- **ìë™ rename ì •ì±…**: ë™ì¼ parent ë‚´ ì´ë¦„ ì¶©ëŒ ì‹œ, ì´ë¦„ ë’¤ì— **` (1)`, ` (2)`â€¦**ë¥¼ ë¶™ì—¬ ìœ ë‹ˆí¬ ë³´ì¥
- **ì´ë™ ê°€ëŠ¥ ë²”ìœ„**: í•­ìƒ **`/docs` ë‚´ë¶€**ì—ì„œë§Œ ì´ë™ ê°€ëŠ¥ (`/` ë˜ëŠ” `/category` ê°™ì€ ê°€ìƒ ê²½ë¡œëŠ” UIìš©ì´ë©° DB ê²½ë¡œëŠ” `/docs/...`)
- **DnD ë²”ìœ„**: ë“œë˜ê·¸ì•¤ë“œë¡­ì€ **ì• ë‹ˆë©”ì´ì…˜ ì™„ì„±ê¹Œì§€ í¬í•¨** (ë‹¨ìˆœ í•˜ì´ë¼ì´íŠ¸ê°€ ì•„ë‹ˆë¼ â€œë„£ëŠ” ì• ë‹ˆë©”ì´ì…˜â€ê¹Œì§€)

### 8.2 í˜„ ìƒíƒœ(AS-IS) ê´€ì°° ìš”ì•½

- Breadcrumbê°€ í˜„ì¬ **íƒ€ì´í‹€(h1) + breadcrumb nav**ë¥¼ í•¨ê»˜ ë Œë”ë§í•˜ê³ , `Layout`ì˜ `.header`ê°€ ì´ë¯¸ stickyì…ë‹ˆë‹¤. â†’ ì—­í•  ë¶„ë¦¬ í•„ìš”
- `fetchAllDocs()`ê°€ ì—¬ëŸ¬ í›…/ì»¨í…Œì´ë„ˆì—ì„œ ì¤‘ë³µ í˜¸ì¶œë©ë‹ˆë‹¤. â†’ ìºì‹±/ë‹¨ì¼ ë°ì´í„° ì†ŒìŠ¤ í•„ìš”
- íŠ¸ë¦¬ ë¹Œë”ê°€ í´ë” ë…¸ë“œì˜ `id/path` ë©”íƒ€ë¥¼ íŠ¸ë¦¬ ê²°ê³¼ì—ì„œ ì œê±°í•©ë‹ˆë‹¤. â†’ í´ë” ì‚­ì œ/ì´ë™/DnD íƒ€ê²Ÿ íŒë³„ì´ ì–´ë ¤ì›€
- ë°±ì—”ë“œì— CRUDëŠ” ìˆìœ¼ë‚˜ **ì´ë™(move) APIê°€ ì—†ìŠµë‹ˆë‹¤.**

### 8.3 ë³€ê²½ í›„(TO-BE) UX êµ¬ì„±

#### 8.3.1 Breadcrumb ì—­í•  ë¶„ë¦¬

- **Title ì˜ì—­**: `Layout` headerì— ìœ„ì¹˜ (ë¬¸ì„œ íƒ€ì´í‹€/ì™¸ë¶€ë§í¬ ë“±)
- **Breadcrumb Nav ì˜ì—­**: ì½˜í…ì¸  ì˜ì—­ ìƒë‹¨ì— ìœ„ì¹˜, **stickyë¡œ í•­ìƒ ë…¸ì¶œ**
  - ìŠ¤í¬ë¡¤ ê¸°ì¤€ì€ `main` ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ(í˜„ì¬ `.layout__main`)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•¨

#### 8.3.2 Layout ë†’ì´/ìŠ¤í¬ë¡¤ ì •ì±…

- ê¸°ì¡´ì²˜ëŸ¼ header ë†’ì´ë¥¼ `--header-height`ë¡œ ê³„ì‚°í•˜ëŠ” êµ¬ì¡°ëŠ” ìœ ì§€í•˜ë˜,
  - headerì—ì„œ Breadcrumb Navê°€ ë¹ ì§€ë¯€ë¡œ header ë†’ì´ ê°ì†Œ
  - main ìƒë‹¨ì— breadcrumb barê°€ ì¶”ê°€ë˜ë¯€ë¡œ main ë‚´ë¶€ ë ˆì´ì•„ì›ƒ(íŒ¨ë”©/ë†’ì´/ìŠ¤í‹°í‚¤ ê¸°ì¤€)ì„ ì¬ì¡°ì •

### 8.4 TanStack Query ì ìš©(ìºì‹± ì „ëµ + ë¡œì§ ìº¡ìŠí™”)

#### 8.4.1 ëª©í‘œ

- ëª¨ë“  API í˜¸ì¶œì„ Query/Mutationìœ¼ë¡œ í†µí•©í•˜ì—¬
  - ì¤‘ë³µ ìš”ì²­ ì œê±°
  - invalidate ì „ëµìœ¼ë¡œ UI ë™ê¸°í™”
  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í›…ìœ¼ë¡œ ìº¡ìŠí™”

#### 8.4.2 ê¶Œì¥ Query Key ì„¤ê³„

- `docs.tree` : ì „ì²´ ë…¸ë“œ(íŠ¸ë¦¬ ë¹Œë“œì˜ ì›ì²œ)
- `docs.content.{path}` : ë¬¸ì„œ ë³¸ë¬¸(path ê¸°ì¤€)
- `auth.me` : í˜„ì¬ ì‚¬ìš©ì

#### 8.4.3 ìºì‹±/ë¬´íš¨í™”(Invalidate) ê¸°ë³¸ ì •ì±…

- **íŠ¸ë¦¬(`docs.tree`)**: `staleTime` ê¸¸ê²Œ(ì˜ˆ: 30~120s) + mutation ì„±ê³µ ì‹œ invalidate
- **ë³¸ë¬¸(`docs.content.{path}`)**: pathë³„ ìºì‹œ + ì´ë™/ì‚­ì œ ì‹œ ê´€ë ¨ keyë¥¼ invalidate/remove
- **mutation í›„ ë™ê¸°í™”**:
  - create/update/delete/move ì„±ê³µ â†’ `docs.tree` invalidate
  - í˜„ì¬ ë³´ê³  ìˆëŠ” ê²½ë¡œê°€ ì´ë™/ì‚­ì œëœ ê²½ìš° â†’ ìƒˆ ê²½ë¡œë¡œ navigate ë˜ëŠ” ìƒìœ„ë¡œ fallback

> Preact í™˜ê²½ì—ì„œ TanStack Queryë¥¼ ì ìš©í•  ë•ŒëŠ” `@tanstack/react-query` ì‚¬ìš©ì„ ìœ„í•´ `preact/compat` alias ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Phase 2ì—ì„œ â€œë„ì… ë°©ì‹â€ì„ ë¨¼ì € ê²°ì •)

### 8.5 ì½˜í…ì¸  FolderItem â‹¯ ë©”ë‰´ + ì‚­ì œ

#### 8.5.1 ìš”êµ¬ì‚¬í•­

- ì½˜í…ì¸  ê·¸ë¦¬ë“œì˜ í´ë”/íŒŒì¼ ì¹´ë“œ ìš°ìƒë‹¨ì— **â‹¯ ë©”ë‰´**
- ë©”ë‰´ í•­ëª©: ìµœì†Œ **â€œì‚­ì œâ€**

#### 8.5.2 ë°ì´í„° ìš”ê±´(í´ë” ì‹ë³„ì)

í˜„ì¬ íŒŒì¼ì€ `_files[]`ì— `id`ê°€ ì¡´ì¬í•˜ì§€ë§Œ í´ë”ëŠ” íŠ¸ë¦¬ì— `id`ê°€ ì—†ì–´, ì•„ë˜ ì¤‘ 1ê°œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.

- **ì•ˆ A(ê¶Œì¥)**: íŠ¸ë¦¬ ë…¸ë“œì— `_meta` ìœ ì§€
  - ì˜ˆ: ê° í´ë” ê°ì²´ì— `_meta: { id, path, name, type: 'DIRECTORY' }`
- **ì•ˆ B**: `path -> id` ë§µì„ ë³„ë„ ìƒì„±í•˜ì—¬ UIì— ì£¼ì…

ì‚­ì œ ì‹œ ì„œë²„ ê¶Œí•œ ì •ì±…(ë³¸ì¸ë§Œ) ìœ„ë°˜ì´ë©´ 403ì„ ë°˜í™˜í•˜ê³ , UIëŠ” í† ìŠ¤íŠ¸/ì•Œë¦¼ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### 8.6 ë“œë˜ê·¸ì•¤ë“œë¡­ (ì½˜í…ì¸  + ì‚¬ì´ë“œë°”) â€” ì• ë‹ˆë©”ì´ì…˜ í¬í•¨

#### 8.6.1 ê³µí†µ ê·œì¹™

- **ë“œë˜ê·¸ ì†ŒìŠ¤**: í´ë”/íŒŒì¼
- **ë“œë¡­ íƒ€ê²Ÿ**: í´ë”ë§Œ (íŒŒì¼ì€ íƒ€ê²Ÿ ë¶ˆê°€)
- **ì´ë™ ë²”ìœ„ ì œí•œ**: target parentëŠ” ë°˜ë“œì‹œ `/docs` ë‚´ë¶€ì˜ DIRECTORY

#### 8.6.2 ì½˜í…ì¸  ì˜ì—­ DnD

- í´ë”/íŒŒì¼ì„ ë‹¤ë¥¸ í´ë”ë¡œ ë“œë¡­í•˜ë©´ í•´ë‹¹ í´ë”ë¡œ ì´ë™
- â€œìƒìœ„ë¡œ ë¹¼ê¸°â€ëŠ” breadcrumb barì˜ **ì „ìš© ë“œë¡­ ì•„ì´ì½˜(Up/Back)** ìœ„ì— ë“œë¡­ ì‹œ ë™ì‘

#### 8.6.3 ì‚¬ì´ë“œë°” DnD

- íŠ¸ë¦¬ ë…¸ë“œ(í´ë”/íŒŒì¼)ë¥¼ ë‹¤ë¥¸ í´ë”ë¡œ ì´ë™í•˜ëŠ” UX/ë¡œì§ì€ ì½˜í…ì¸ ì™€ ë™ì¼
- â€œë°”ê¹¥ìœ¼ë¡œ ë¹¼ê¸°â€ëŠ” breadcrumb ì „ìš© ë“œë¡­ ì¡´ê³¼ ë™ì¼í•œ ê°œë…ì„ ì‚¬ì´ë“œë°”ì—ì„œë„ ì œê³µ(í˜¹ì€ ê³µìš© ë“œë¡­ ì¡´ ì‚¬ìš©)

#### 8.6.4 ì• ë‹ˆë©”ì´ì…˜ ìš”êµ¬ì‚¬í•­(ì™„ì„± ê¸°ì¤€)

- **Drag over**: ë“œë¡­ ê°€ëŠ¥ íƒ€ê²Ÿ í•˜ì´ë¼ì´íŠ¸ + í´ë” ì•„ì´ì½˜/ë°°ê²½ ë³€í™”
- **Drop(ë„£ê¸°) ì• ë‹ˆë©”ì´ì…˜**: ë“œë˜ê·¸ ì•„ì´í…œì´ íƒ€ê²Ÿ í´ë”ë¡œ â€œí¡ìˆ˜â€ë˜ëŠ” ëª¨ì…˜
  - êµ¬í˜„ í›„ë³´: FLIP(First-Last-Invert-Play) ë˜ëŠ” Web Animations API ê¸°ë°˜
- **ë‚™ê´€ì  UI(ê¶Œì¥)**:
  - ë“œë¡­ ì¦‰ì‹œ UI íŠ¸ë¦¬/ê·¸ë¦¬ë“œì—ì„œ ì´ë™ ë°˜ì˜ + ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
  - API ì‹¤íŒ¨ ì‹œ ì›ë³µ(ë¡¤ë°±) + ì‹¤íŒ¨ í† ìŠ¤íŠ¸

### 8.7 ë°±ì—”ë“œ: Move API ì„¤ê³„(Phase 2 í•µì‹¬)

#### 8.7.1 Endpoint(ì œì•ˆ)

- `PATCH /api/docs/:id/move`
  - Body: `{ "target_parent_path": "/docs/Some/Folder" }`

#### 8.7.2 ì„œë²„ ê²€ì¦/ì œì•½

- **ì¸ì¦ í•„ìˆ˜** + **ë³¸ì¸(author_id)ë§Œ ì´ë™ ê°€ëŠ¥**
- **target parent ê²€ì¦**:
  - ì¡´ì¬í•´ì•¼ í•¨
  - `type === 'DIRECTORY'` ì—¬ì•¼ í•¨
  - `path`ê°€ ë°˜ë“œì‹œ `/docs`ë¡œ ì‹œì‘í•´ì•¼ í•¨
- **cycle ë°©ì§€(í´ë” ì´ë™)**:
  - í´ë”ë¥¼ ìì‹ ì˜ í•˜ìœ„ë¡œ ì´ë™ ê¸ˆì§€
  - (ì˜ˆ) oldPath=`/docs/A`, targetParentPath=`/docs/A/B` â†’ 400/409

#### 8.7.3 path/name ì¶©ëŒ ì²˜ë¦¬(ìë™ rename)

- ë™ì¼ parentì— ê°™ì€ nameì´ ìˆìœ¼ë©´:
  - í´ë”: `Folder` â†’ `Folder (1)` â†’ `Folder (2)`â€¦
  - íŒŒì¼: í™•ì¥ì ë³´ì¡´
    - `guide.md` â†’ `guide (1).md` â†’ `guide (2).md`â€¦
- êµ¬í˜„ ê´€ì :
  - DBëŠ” `(parent_id, name)` ìœ ë‹ˆí¬ê°€ ìˆìœ¼ë¯€ë¡œ, ì„œë²„ì—ì„œ â€œì‚¬ìš© ê°€ëŠ¥í•œ nameâ€ì„ ê³„ì‚° í›„ ì €ì¥

#### 8.7.4 DIRECTORY ì´ë™ ì‹œ í•˜ìœ„ ë…¸ë“œ path ì¼ê´„ ê°±ì‹ 

- í´ë” ì´ë™ì€ â€œìê¸° ìì‹  + ëª¨ë“  descendantsâ€ì˜ `path` prefixê°€ ë°”ë€Œë¯€ë¡œ,
  - `oldPrefix` â†’ `newPrefix`ë¡œ ë¬¸ìì—´ ì¹˜í™˜ ì—…ë°ì´íŠ¸ê°€ í•„ìš”
  - ì¶©ëŒ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬(íŠ¸ëœì­ì…˜/ìˆœì„œ/ê²€ì¦ ì „ëµ í¬í•¨)

### 8.8 ì‘ì—… TODO (ì²´í¬ë¦¬ìŠ¤íŠ¸)

- [ ] Breadcrumb: íƒ€ì´í‹€/ë„¤ë¹„ ë¶„ë¦¬, íƒ€ì´í‹€ì€ `Layout`ë¡œ ì´ë™
- [ ] Breadcrumb Nav: ì½˜í…ì¸  ìƒë‹¨ sticky ì²˜ë¦¬ + â€œìƒìœ„ ì´ë™ ë“œë¡­ ì¡´â€ UI ì¶”ê°€
- [ ] Layout: header ë†’ì´ ê°ì†Œ ë°˜ì˜ + main ìŠ¤í¬ë¡¤/íŒ¨ë”© ì¬ì¡°ì •
- [ ] TanStack Query: QueryClient ë„ì… + Query Key/ìºì‹± ì „ëµ í™•ì •
- [ ] ê¸°ì¡´ ì¤‘ë³µ fetch ì œê±°: `fetchAllDocs()` í˜¸ì¶œ ê²½ë¡œ ë‹¨ì¼í™”
- [ ] íŠ¸ë¦¬ ë°ì´í„°: í´ë” id/path ë©”íƒ€ ì œê³µ ë°©ì‹ ê²°ì •(\_meta vs path->id map)
- [ ] DirectoryView: í´ë”/íŒŒì¼ ì¹´ë“œ â‹¯ ë©”ë‰´ + â€œì‚­ì œâ€ ì—°ê²°
- [ ] ì„œë²„: `PATCH /api/docs/:id/move` êµ¬í˜„(ê¶Œí•œ/rename/cycle/í•˜ìœ„ path ê°±ì‹ )
- [ ] DnD(ì½˜í…ì¸ ): í´ë”/íŒŒì¼ ë“œë˜ê·¸ â†’ í´ë” ë“œë¡­ ì´ë™ + í¡ìˆ˜ ì• ë‹ˆë©”ì´ì…˜
- [ ] DnD(ì‚¬ì´ë“œë°”): ë™ì¼ ê¸°ëŠ¥ + ë™ì¼ ì• ë‹ˆë©”ì´ì…˜/ë¡¤ë°± ì •ì±…
- [ ] ì‹¤íŒ¨ ë¡¤ë°±: optimistic UI ì ìš© + ì‹¤íŒ¨ ì‹œ ì›ë³µ/í† ìŠ¤íŠ¸
- [ ] í…ŒìŠ¤íŠ¸: rename ì•Œê³ ë¦¬ì¦˜, cycle ë°©ì§€, move API ì£¼ìš” ì¼€ì´ìŠ¤, query invalidate ê²€ì¦

### 8.9 ì‘ì—… ìˆœì„œ(ê¶Œì¥)

1. Breadcrumb/ë ˆì´ì•„ì›ƒ ë¶„ë¦¬(ìŠ¤í¬ë¡¤/ë†’ì´ ì¬ì •ì˜)
2. TanStack Query ë„ì… + ê¸°ì¡´ ì¤‘ë³µ fetch ì œê±°
3. íŠ¸ë¦¬ ë°ì´í„° êµ¬ì¡°ì— í´ë” ë©”íƒ€(id/path) ë³´ê°•
4. ì½˜í…ì¸  â‹¯ ë©”ë‰´ + ì‚­ì œ ì—°ê²°(ê¶Œí•œ/í† ìŠ¤íŠ¸/ë¬´íš¨í™”)
5. Move API(ì„œë²„) êµ¬í˜„ + í´ë¼ì´ì–¸íŠ¸ ì´ë™ ë¡œì§ ì—°ê²°
6. DnD(ì½˜í…ì¸ ) â†’ DnD(ì‚¬ì´ë“œë°”) ìˆœì„œë¡œ í™•ì¥
7. ì• ë‹ˆë©”ì´ì…˜ polish + ì‹¤íŒ¨ ë¡¤ë°±/ì—ëŸ¬ í•¸ë“¤ë§ ë§ˆê°
