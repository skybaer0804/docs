# 아키텍처 문서

## 1. 시스템 개요

Spark Messaging API Gateway는 실시간 Socket.IO 기반 백엔드 서비스와 클라이언트 간의 안전한 통신을 위한 API Gateway입니다. 인증, 권한 관리, 보안, 접근 통제 기능을 제공합니다.

## 2. 아키텍처 다이어그램

```
┌─────────────────┐
│   클라이언트     │
│  (웹앱/서버)    │
│   + SDK         │
└────────┬────────┘
         │ HTTPS/WSS
         │ (인증 토큰 포함)
         ▼
┌─────────────────────────────────┐
│      API Gateway                │
│  ┌───────────────────────────┐ │
│  │  인증 미들웨어             │ │
│  │  - API Key 검증            │ │
│  │  - JWT 검증                │ │
│  └───────────────────────────┘ │
│  ┌───────────────────────────┐ │
│  │  권한 검증 미들웨어        │ │
│  │  - 이벤트 타입별 접근 제어 │ │
│  └───────────────────────────┘ │
│  ┌───────────────────────────┐ │
│  │  라우팅 & 로깅            │ │
│  └───────────────────────────┘ │
└────────┬────────────────────────┘
         │ WSS (인증된 연결)
         ▼
┌─────────────────────────────────┐
│   Socket.IO 백엔드 서버         │
│  ┌───────────────────────────┐ │
│  │  네임스페이스 관리         │ │
│  │  - /chat                   │ │
│  │  - /notification           │ │
│  │  - /system                 │ │
│  │  - /error                  │ │
│  └───────────────────────────┘ │
│  ┌───────────────────────────┐ │
│  │  룸 관리                   │ │
│  └───────────────────────────┘ │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│   Auth & Key 관리 MSA           │
│  - 키 발급/회수/갱신            │
│  - 권한 정책 관리               │
└─────────────────────────────────┘
```

## 3. 컴포넌트 상세

### 3.1 클라이언트 SDK
- API Gateway를 통한 인증 토큰 획득
- Socket.IO 연결 관리
- 재접속 로직 포함
- 이벤트 타입별 메시지 송수신

### 3.2 API Gateway
- **인증 모듈**: API Key/JWT 검증
- **권한 모듈**: 이벤트 타입별 접근 제어
- **라우팅 모듈**: 요청을 적절한 Socket.IO 서버로 전달
- **로깅 모듈**: 모든 인증 시도 및 결과 기록
- **보안 모듈**: IP 화이트리스트, Rate Limiting

### 3.3 Socket.IO 백엔드
- 인증된 클라이언트만 연결 허용
- 네임스페이스별 이벤트 처리
- 세션 관리 및 재접속 처리

### 3.4 Auth & Key 관리 MSA
- 키 발급 및 회수
- 키 회전(재발급)
- 권한 정책 관리
- 키 사용 로그

## 4. 데이터 흐름

### 4.1 인증 플로우
1. 클라이언트가 API Key로 `/auth/token` 호출
2. API Gateway가 Key 관리 MSA에 검증 요청
3. 검증 성공 시 JWT 토큰 발급
4. 클라이언트가 JWT 토큰을 저장

### 4.2 Socket.IO 연결 플로우
1. 클라이언트가 SDK를 통해 Socket.IO 연결 시도
2. API Gateway가 연결 요청을 가로채 인증 검증
3. 권한 검증 (요청한 네임스페이스/이벤트 타입 확인)
4. 검증 성공 시 Socket.IO 서버로 연결 전달
5. Socket.IO 서버가 세션 생성 및 연결 완료

### 4.3 메시지 송수신 플로우
1. 클라이언트가 메시지 전송 요청
2. API Gateway가 인증 및 권한 재검증
3. 이벤트 타입별 권한 확인
4. 권한 통과 시 Socket.IO 서버로 메시지 전달
5. Socket.IO 서버가 대상 클라이언트에게 메시지 전송

## 5. 보안 계층

### 5.1 네트워크 레벨
- TLS/SSL 필수 적용
- IP 화이트리스트 (선택)
- DDoS 방어

### 5.2 인증 레벨
- API Key 기반 인증
- JWT 토큰 기반 인증
- 토큰 만료 및 갱신

### 5.3 권한 레벨
- 이벤트 타입별 접근 제어
- 네임스페이스별 접근 제어
- 룸별 접근 제어

### 5.4 모니터링 레벨
- 비정상 접근 탐지
- 과다 요청 탐지
- 실시간 알림

## 6. 기술 스택

### 6.1 API Gateway
- Node.js + TypeScript
- Express.js (REST API)
- Socket.IO Client (백엔드 연결)
- JWT (토큰 관리)
- Redis (세션/캐시 관리)

### 6.2 Socket.IO 백엔드
- Node.js + TypeScript
- Socket.IO Server
- Redis Adapter (클러스터링)

### 6.3 데이터 저장소
- Redis: 세션, 캐시, 실시간 데이터
- PostgreSQL: 키 관리, 로그, 정책

### 6.4 모니터링
- Winston (로깅)
- Prometheus (메트릭)
- Grafana (대시보드)

## 7. 확장성 고려사항

### 7.1 수평 확장
- API Gateway 다중 인스턴스
- Socket.IO Redis Adapter를 통한 클러스터링
- 로드 밸런서를 통한 트래픽 분산

### 7.2 성능 최적화
- Redis 캐싱
- 연결 풀링
- 비동기 처리

### 7.3 고가용성
- Health Check 엔드포인트
- 자동 재시작
- 장애 복구 메커니즘

