# 프로젝트 개선안 v2.5.0

본 문서는 마크다운 목차 네비게이션 개선 및 문서별 사용자 행동 분석(Analytics) 시스템 도입을 위한 설계안입니다.

---

## 1. 마크다운 목차(TOC) 스크롤 네비게이션 개선

### 1.1 개요

사용자가 마크다운 문서의 목차를 클릭했을 때, 해당 섹션으로 부드럽게 이동하고 상단 헤더에 가려지지 않도록 개선합니다.

### 1.2 주요 기능

- **자동 ID 할당:** 마크다운 변환 시 헤더(`h1`~`h6`)에 텍스트 기반의 고유 ID를 부여합니다.
- **Smooth Scroll:** 이동 시 브라우저 내장 기능을 활용하여 부드럽게 스크롤됩니다.
- **Scroll Offset:** 상단 네비게이션 바의 높이를 고려하여 섹션 제목이 가려지지 않게 `scroll-margin-top`을 적용합니다.

---

## 2. 사용자 행동 분석(Analytics) 시스템 설계

### 2.1 개요

어떤 사용자가 어떤 파일을 얼마나 오랫동안 보았는지, 그리고 다운로드를 수행했는지를 추적하여 통계 데이터를 구축합니다.

### 2.2 목적

- 인기 있는 문서 파악
- 사용자별 관심사 분석
- 문서의 실제 유용성(체류 시간 기반) 검증

---

## 3. Supabase 데이터베이스 설계 (DDL)

이 작업은 **Supabase SQL Editor**에서 직접 실행하여 생성합니다. Supabase는 PostgreSQL 기반이므로 뷰(View) 생성이 가능하며, 생성된 뷰는 Supabase API를 통해 일반 테이블처럼 조회할 수 있습니다.

### 3.1 로그 테이블 생성 (`node_interactions`)

모든 개별 행동(View, Download)을 기록하는 기초 테이블입니다.

```sql
-- 로그 테이블 생성
CREATE TABLE public.node_interactions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    node_id UUID NOT NULL REFERENCES public.nodes(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.users(id), -- 로그인한 경우 유저 ID 기록
    interaction_type TEXT NOT NULL CHECK (interaction_type IN ('view', 'download')),
    duration_sec INTEGER DEFAULT 0, -- 체류 시간 (초)
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 인덱스 생성 (조회 성능 최적화)
CREATE INDEX idx_node_interactions_node_id ON public.node_interactions(node_id);
CREATE INDEX idx_node_interactions_user_id ON public.node_interactions(user_id);
```

### 3.2 통계 뷰 생성 (`v_file_analytics`)

요청하신 주요 컬럼을 포함하며, 체류 시간을 범주화하여 제공하는 분석용 뷰입니다.

```sql
-- 통계 뷰 생성
CREATE OR REPLACE VIEW public.v_file_analytics AS
SELECT
    n.id AS node_id,              -- nodes 테이블의 FILE type ID
    u.id AS user_id,              -- users 테이블의 ID
    u.username,                   -- 유저 이름 (조인)
    n.name AS file_name,          -- 파일명
    -- 다운로드 횟수 계산
    COUNT(CASE WHEN i.interaction_type = 'download' THEN 1 END) AS download_count,
    -- 뷰 횟수 계산
    COUNT(CASE WHEN i.interaction_type = 'view' THEN 1 END) AS view_count,
    -- 총 체류 시간 및 범주화
    SUM(i.duration_sec) AS total_duration_sec,
    CASE
        WHEN SUM(i.duration_sec) < 60 THEN '1분 미만'
        WHEN SUM(i.duration_sec) < 600 THEN '1분~10분'
        WHEN SUM(i.duration_sec) < 1800 THEN '10분~30분'
        WHEN SUM(i.duration_sec) >= 3600 THEN '1시간 이상'
        ELSE '30분~1시간'
    END AS duration_category,
    MAX(i.created_at) AS last_interaction_at
FROM public.nodes n
JOIN public.node_interactions i ON n.id = i.node_id
LEFT JOIN public.users u ON i.user_id = u.id
WHERE n.type = 'FILE'
GROUP BY n.id, n.name, u.id, u.username;
```

---

## 4. 질의응답 (Q&A)

**Q: 통계 뷰는 Supabase에서 가능한가요, 아니면 백엔드에서 별도로 만드나요?**
**A:** **Supabase(PostgreSQL)에서 직접 만드는 것이 베스트입니다.**

- Supabase SQL Editor에서 위 `CREATE VIEW` 문을 실행하면 DB 내에 뷰가 생성됩니다.
- 생성된 뷰는 Supabase JS SDK에서 `supabase.from('v_file_analytics').select('*')`와 같이 일반 테이블처럼 조회할 수 있습니다.
- 백엔드(Node.js)에서 복잡한 집계 로직을 짤 필요 없이 DB의 성능을 활용할 수 있어 훨씬 효율적입니다.

---

## 5. 추후 활용 및 확장 방안

1.  **실시간 트렌딩:** 최근 24시간 내 `view_count`가 가장 높은 문서를 상단에 노출합니다.
2.  **개인화 추천:** 사용자가 자주 보는 `duration_category`가 높은 문서의 카테고리를 분석하여 유사한 문서를 추천합니다.
3.  **저자 대시보드:** 내가 올린 파일들의 다운로드 수와 평균 체류 시간을 시각화하여 제공합니다.
4.  **자동 이탈 감지:** 체류 시간이 특정 시간(예: 3초) 미만인 뷰가 많다면 문서의 제목과 내용의 불일치 여부를 관리자에게 알립니다.
