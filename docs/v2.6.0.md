# Docs 프로젝트에 웹 푸시 기능 추가하기

> 이 문서는 Vite + Express.js 프로젝트에 웹 푸시 알림 기능을 추가하는 초보자용 가이드입니다.  
> 마지막 업데이트: 2026년 1월

## 목차

1. [개요](#개요)
2. [기능 요구사항](#기능-요구사항)
3. [구조 및 동작 원리](#구조-및-동작-원리)
4. [1단계: 필수 패키지 설치](#1단계-필수-패키지-설치)
5. [2단계: VAPID 키 생성](#2단계-vapid-키-생성)
6. [3단계: 백엔드 구현 (Express)](#3단계-백엔드-구현-express)
7. [4단계: 프론트엔드 구현 (Vite)](#4단계-프론트엔드-구현-vite)
8. [5단계: 서비스 워커 구현](#5단계-서비스-워커-구현)
9. [6단계: 테스트](#6단계-테스트)
10. [트러블슈팅](#트러블슈팅)

---

## 개요

### 웹 푸시란?

웹 푸시는 서버에서 사용자 브라우저로 메시지를 보내는 기술입니다.

- 사용자가 페이지를 닫아도 메시지를 수신할 수 있습니다.
- OS 알림처럼 보입니다.
- 모바일(홈화면 추가)에서도 작동합니다.

### 이 프로젝트의 용도

Docs 프로젝트에서:

- **문서 조회**: 10회, 100회 달성 시
- **다운로드**: 1회, 10회 달성 시

문서 주인에게 성과를 알려주는 웹 푸시를 보냅니다.

---

## 기능 요구사항

| 항목          | 내용                           |
| ------------- | ------------------------------ |
| **발신자**    | Express.js 백엔드              |
| **수신자**    | 사용자 브라우저 (서비스 워커)  |
| **트리거**    | 문서 조회/다운로드 수 달성     |
| **알림 형식** | 브라우저 OS 알림 (배너/토스트) |
| **동작 환경** | PC, 모바일(홈화면 추가), PWA   |

---

## 구조 및 동작 원리

```
사용자 행동 (조회/다운로드)
        ↓
Express 백엔드 감지
        ↓
조건 확인 (10회, 100회 등)
        ↓
서버에서 web-push 라이브러리로 푸시 메시지 발송
        ↓
푸시 서비스 (FCM, APNs 등) 경유
        ↓
사용자 브라우저 수신
        ↓
서비스 워커 활성화
        ↓
Notification API로 화면에 알림 표시
```

### 핵심 개념

1. **VAPID (Voluntary Application Server Identification)**

   - 서버가 푸시 서비스에 자신을 인증하기 위한 공개/개인 키 쌍
   - 보안 목적

2. **PushSubscription**

   - 사용자 브라우저의 고유한 구독 정보
   - 데이터베이스에 저장해야 함

3. **서비스 워커 (Service Worker)**
   - 백그라운드에서 실행되는 스크립트
   - 푸시 메시지 수신 시 알림 표시

---

## 1단계: 필수 패키지 설치

### 백엔드

```bash
npm install web-push
```

### 필요한 경우

```bash
# 환경 변수 관리 (선택)
npm install dotenv
```

### 확인

```bash
npm list web-push
```

---

## 2단계: VAPID 키 설정

VAPID 키는 서버와 클라이언트 간의 인증을 위한 암호화 키 쌍입니다.

### 프로젝트 전용 VAPID 키 (테스트용)

**Public Key (공개 키):**
`BBE0_v9v_L5Y8kU6q8X7z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O3N2M1L0K9J8I7H6G5F4E3D2C1B0A`

**Private Key (개인 키):**
`u7_X8z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O`

### 저장 위치

**.env** 파일에 저장:

```env
# .env (서버 루트)
VAPID_PUBLIC_KEY=BBE0_v9v_L5Y8kU6q8X7z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O3N2M1L0K9J8I7H6G5F4E3D2C1B0A
VAPID_PRIVATE_KEY=u7_X8z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O
VAPID_SUBJECT=mailto:admin@example.com
```

### 주의사항

⚠️ **Private Key는 절대 공개하지 마세요!**

- 깃허브에 업로드하지 말기
- .gitignore에 .env 추가하기

```gitignore
# .gitignore
.env
.env.local
```

---

## 3단계: 백엔드 구현 (Express)

### 3.1 웹 푸시 설정

**server/src/config/webpush.js**

```javascript
const webpush = require('web-push');
require('dotenv').config();

// VAPID 키 설정
webpush.setVapidDetails(
  process.env.VAPID_SUBJECT, // mailto:example@email.com 형식 필수
  process.env.VAPID_PUBLIC_KEY,
  process.env.VAPID_PRIVATE_KEY,
);

module.exports = webpush;
```

### 3.2 구독 저장 엔드포인트

**server/src/controllers/pushController.js**

```javascript
exports.subscribe = async (req, res) => {
  try {
    const { subscription } = req.body;
    const userId = req.user.id;

    // Upsert: 동일한 브라우저(endpoint) 정보가 있으면 업데이트, 없으면 신규 저장
    const { error } = await supabase.from('push_subscriptions').upsert(
      {
        user_id: userId,
        endpoint: subscription.endpoint,
        p256dh: subscription.keys.p256dh,
        auth: subscription.keys.auth,
      },
      { onConflict: 'endpoint' },
    );

    if (error) throw error;
    res.status(201).json({ message: '구독 성공' });
  } catch (error) {
    res.status(500).json({ error: '서버 오류' });
  }
};
```

### 3.3 실시간 팔로우 알림 로직

누군가 나를 팔로우할 때 비동기로 푸시 알림을 발송합니다.

**server/src/controllers/subscriptionController.js**

```javascript
// 팔로우 성공 후 푸시 발송 (비동기 처리)
(async () => {
  try {
    const webpush = require('../config/webpush');

    // 1. 팔로우 대상의 푸시 구독 정보 조회
    const { data: subs } = await supabase.from('push_subscriptions').select('*').eq('user_id', following_id);

    if (subs && subs.length > 0) {
      const payload = JSON.stringify({
        title: '새로운 팔로워! 🎉',
        body: `${follower.username}님이 당신을 구독하기 시작했습니다!`,
        icon: '/icons/icon-192x192.png',
        data: { url: `/profile/${follower.username}` },
      });

      // 2. 등록된 모든 기기에 알림 전송
      subs.forEach((sub) => {
        webpush
          .sendNotification(
            {
              endpoint: sub.endpoint,
              keys: { p256dh: sub.p256dh, auth: sub.auth },
            },
            payload,
          )
          .catch((err) => {
            if (err.statusCode === 410) {
              // 만료된 구독 정보 DB에서 삭제
              supabase.from('push_subscriptions').delete().eq('id', sub.id).then();
            }
          });
      });
    }
  } catch (pushErr) {
    console.error('푸시 알림 전송 실패:', pushErr);
  }
})();
```

---

## 4단계: 프론트엔드 구현 (Vite PWA 통합)

### 4.1 PWA 설정 수정 (InjectManifest)

커스텀 서비스 워커 로직을 유지하면서 PWA 기능을 사용하기 위해 `injectManifest` 전략을 사용합니다.

**client/vite.config.js**

```javascript
VitePWA({
  strategies: 'injectManifest',
  srcDir: 'src',
  filename: 'sw.js',
  registerType: 'autoUpdate',
  devOptions: {
    enabled: true, // 로컬(localhost) 테스트 필수
    type: 'module',
  },
});
```

### 4.2 알림 구독 Hook

**client/src/hooks/useNotification.js**

`navigator.serviceWorker.ready`를 통해 PWA 플러그인이 등록한 서비스 워커 인스턴스를 가져와 푸시 구독을 진행합니다.

---

## 5단계: 통합 서비스 워커 구현

**client/src/sw.js**

PWA의 자산 프리캐싱 로직과 웹 푸시 수신(`push`) 이벤트를 하나의 파일에서 통합 관리합니다.

```javascript
import { precacheAndRoute } from 'workbox-precaching';

// 프리캐시 매니페스트 주입
precacheAndRoute(self.__WB_MANIFEST);

/**
 * 웹 푸시 메시지 수신 이벤트
 */
self.addEventListener('push', (event) => {
  const data = event.data ? event.data.json() : {};

  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: '/assets/icon-192x192.svg',
      badge: '/assets/favicon.svg',
      vibrate: [200, 100, 200],
      data: data.data, // 클릭 시 이동할 URL 등 정보 포함
    }),
  );
});

/**
 * 알림 클릭 이벤트
 */
self.addEventListener('notificationclick', (event) => {
  event.notification.close();
  const urlToOpen = event.notification.data?.url || '/';

  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      for (const client of clientList) {
        if (client.url.includes(urlToOpen) && 'focus' in client) return client.focus();
      }
      if (clients.openWindow) return clients.openWindow(urlToOpen);
    }),
  );
});
```

---

## 6단계: 테스트 및 디버깅

### 6.1 로컬 환경 테스트 (Localhost)

1. `localhost` 및 `127.0.0.1`은 브라우저에서 'Secure Origin'으로 간주되어 HTTPS 없이도 푸시 기능을 허용합니다.
2. **강력 새로고침**: `Ctrl + F5` 또는 새로고침 버튼 우클릭 -> [캐시 비우기 및 강력 새로고침]을 통해 `sw.js`를 최신 상태로 갱신하세요.
3. **권한 확인**: 주소창 왼쪽의 자물쇠 아이콘을 눌러 '알림' 권한이 **'허용'** 상태인지 반드시 확인하세요.

### 6.2 개발자 도구 활용

- **Application 탭**: `F12` -> Application -> Service Workers 메뉴에서 서비스 워커가 `Running` 상태인지 확인합니다.
- **Push 테스트**: 위 메뉴의 `Push` 버튼에 임의의 JSON을 넣어 브라우저가 알림을 띄우는지 즉시 테스트할 수 있습니다.
- **네트워크 확인**: [알림 켜기] 클릭 시 `/api/push/subscribe` 요청이 정상적으로 가는지 확인하세요.

---

## 체크리스트

프로젝트에 웹 푸시를 추가할 때 다음을 확인하세요:

- [ ] `npm install web-push` 완료
- [ ] `.env` 파일에 VAPID 키 저장
- [ ] `.gitignore`에 `.env` 추가
- [ ] 백엔드: `src/routes/push.js` 구현
- [ ] 백엔드: Express 라우터 등록
- [ ] 프론트엔드: `src/utils/pushSubscription.js` 구현
- [ ] 프론트엔드: `public/service-worker.js` 생성
- [ ] 프론트엔드: `.env.local` 파일에 공개 키 저장
- [ ] 초기화 코드: `initializePush()` 호출 추가
- [ ] 조회/다운로드 추적: `trackDocumentView()`, `trackDocumentDownload()` 호출
- [ ] 테스트: cURL/Postman으로 푸시 메시지 발송 테스트
- [ ] 콘솔 로그 확인: 오류 없는가?

---

## 다음 단계: 데이터베이스 스키마

현 프로젝트의 기존 테이블 구조와 연동되는 푸시 알림 전용 테이블을 추가합니다.

### 기존 테이블 구조 (참고)

- `users`: 사용자 기본 정보 (id: uuid)
- `subscriptions`: 팔로우 관계 (follower_id, following_id: uuid)
- `nodes`: 문서/노드 정보 (author_id: uuid)
- `node_interactions`: 조회/다운로드 기록 (user_id: uuid)

### 신규 추가 테이블: `push_subscriptions`

브라우저별 푸시 토큰 정보를 저장합니다. 한 사용자가 여러 기기(PC, 모바일 등)를 사용할 수 있으므로 사용자당 여러 레코드를 가질 수 있습니다.

```sql
CREATE TABLE push_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL UNIQUE,
  p256dh TEXT NOT NULL,
  auth TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 사용자 아이디로 빠른 조회를 위한 인덱스
CREATE INDEX idx_push_subs_user_id ON push_subscriptions(user_id);
```

---

## 트러블슈팅

운영 환경 배포 및 실사용 중 발생할 수 있는 주요 이슈와 해결 방안입니다.

### Q1: `TypeError: Cannot read properties of undefined (reading 'length')`

**원인**: `VITE_VAPID_PUBLIC_KEY` 환경 변수가 빌드 타임에 정의되지 않았을 때 발생합니다. `urlBase64ToUint8Array` 함수에 `undefined`가 전달되어 내부적으로 `.length`를 참조하려다 발생하는 에러입니다.

**해결책**:

1. **로컬 환경**: `.env.local` 파일에 `VITE_VAPID_PUBLIC_KEY`가 정확히 설정되어 있는지 확인합니다.
2. **운영 환경**: 빌드 환경(Koyeb, GitHub Actions 등)의 환경 변수 설정에 Public Key를 반드시 등록해야 합니다. **Vite는 빌드 타임에 환경 변수를 주입하므로, 변수 설정 후 반드시 다시 빌드(Redeploy)해야 합니다.**

### Q2: `Error: Vapid private key should be 32 bytes long when decoded`

**원인**: 서버에 설정된 `VAPID_PRIVATE_KEY` 값이 잘못되었거나 형식이 맞지 않을 때 발생합니다. (보통 복사 과정에서 공백이 포함되거나 키가 손상된 경우)

**해결책**:

1. `npx web-push generate-vapid-keys` 명령어로 새로운 키 쌍을 생성합니다.
2. 생성된 Private Key를 따옴표나 공백 없이 서버 환경 변수에 정확히 입력합니다.

### Q3: iOS(아이폰) 브라우저에서 "지원하지 않음" 메시지 발생

**원인**: iOS 정책상 일반 브라우저 탭(Safari, Chrome 등)에서는 웹 푸시 API를 직접 사용할 수 없습니다.

**해결책**:

- iOS 16.4 버전 이상부터 웹 푸시를 지원하며, 반드시 **"홈 화면에 추가(Add to Home Screen)"** 기능을 통해 PWA로 설치한 앱 환경에서 실행해야 합니다.
- 사용자에게 홈 화면 추가 방법을 안내하는 가이드를 제공하세요.

### Q4: 브라우저 탭을 닫아도 알림 수신이 가능한가요?

**답변**: **네, 가능합니다.**

- 웹 푸시는 브라우저 탭과 독립적으로 실행되는 **서비스 워커(Service Worker)**를 통해 작동합니다.
- 사용자가 사이트를 닫아도 브라우저 프로세스가 살아있다면 백그라운드에서 푸시를 수신하여 알림을 띄울 수 있습니다.

### Q5: 개발자 도구(DevTools) Push 테스트 시 JSON 에러

**원인**: `sw.js`에서 `event.data.json()`을 호출하는데, 테스트 시 단순 문자열을 보냈기 때문입니다.

**해결책**:

- DevTools Application 탭의 Push 창에서 아래와 같이 **JSON 형식**으로 데이터를 입력하세요.
  ```json
  { "title": "테스트", "body": "메시지 내용" }
  ```

### Q6: DB에 동일한 구독 정보가 중복해서 쌓입니다.

**원인**: 사용자가 '알림 켜기'를 여러 번 누를 때 기존 레코드를 업데이트하지 못하고 신규 생성하기 때문입니다.

**해결책**:

- Supabase/PostgreSQL의 `push_subscriptions` 테이블에서 `endpoint` 컬럼에 **UNIQUE 제약 조건**을 추가하세요.
- 서버 로직에서 `upsert` 기능을 사용하여 `endpoint` 충돌 시 기존 정보를 업데이트하도록 설정합니다.

---

## 참고 자료

- [MDN - Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [MDN - Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [web-push npm 문서](https://github.com/web-push-libs/web-push)
- [Google - Web Push Notifications](https://developers.google.com/web/fundamentals/push-notifications)

---

**문서 버전**: 1.0  
**마지막 수정**: 2026년 1월 5일  
**작성자**: AI Assistant
