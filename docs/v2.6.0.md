# Docs í”„ë¡œì íŠ¸ì— ì›¹ í‘¸ì‹œ ê¸°ëŠ¥ ì¶”ê°€í•˜ê¸°

> ì´ ë¬¸ì„œëŠ” Vite + Express.js í”„ë¡œì íŠ¸ì— ì›¹ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ì´ˆë³´ììš© ê°€ì´ë“œì…ë‹ˆë‹¤.  
> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026ë…„ 1ì›”

## ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­](#ê¸°ëŠ¥-ìš”êµ¬ì‚¬í•­)
3. [êµ¬ì¡° ë° ë™ì‘ ì›ë¦¬](#êµ¬ì¡°-ë°-ë™ì‘-ì›ë¦¬)
4. [1ë‹¨ê³„: í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜](#1ë‹¨ê³„-í•„ìˆ˜-íŒ¨í‚¤ì§€-ì„¤ì¹˜)
5. [2ë‹¨ê³„: VAPID í‚¤ ìƒì„±](#2ë‹¨ê³„-vapid-í‚¤-ìƒì„±)
6. [3ë‹¨ê³„: ë°±ì—”ë“œ êµ¬í˜„ (Express)](#3ë‹¨ê³„-ë°±ì—”ë“œ-êµ¬í˜„-express)
7. [4ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ (Vite)](#4ë‹¨ê³„-í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„-vite)
8. [5ë‹¨ê³„: ì„œë¹„ìŠ¤ ì›Œì»¤ êµ¬í˜„](#5ë‹¨ê³„-ì„œë¹„ìŠ¤-ì›Œì»¤-êµ¬í˜„)
9. [6ë‹¨ê³„: í…ŒìŠ¤íŠ¸](#6ë‹¨ê³„-í…ŒìŠ¤íŠ¸)
10. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ê°œìš”

### ì›¹ í‘¸ì‹œë€?

ì›¹ í‘¸ì‹œëŠ” ì„œë²„ì—ì„œ ì‚¬ìš©ì ë¸Œë¼ìš°ì €ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

- ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ë‹«ì•„ë„ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- OS ì•Œë¦¼ì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.
- ëª¨ë°”ì¼(í™ˆí™”ë©´ ì¶”ê°€)ì—ì„œë„ ì‘ë™í•©ë‹ˆë‹¤.

### ì´ í”„ë¡œì íŠ¸ì˜ ìš©ë„

Docs í”„ë¡œì íŠ¸ì—ì„œ:

- **ë¬¸ì„œ ì¡°íšŒ**: 10íšŒ, 100íšŒ ë‹¬ì„± ì‹œ
- **ë‹¤ìš´ë¡œë“œ**: 1íšŒ, 10íšŒ ë‹¬ì„± ì‹œ

ë¬¸ì„œ ì£¼ì¸ì—ê²Œ ì„±ê³¼ë¥¼ ì•Œë ¤ì£¼ëŠ” ì›¹ í‘¸ì‹œë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

---

## ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

| í•­ëª©          | ë‚´ìš©                           |
| ------------- | ------------------------------ |
| **ë°œì‹ ì**    | Express.js ë°±ì—”ë“œ              |
| **ìˆ˜ì‹ ì**    | ì‚¬ìš©ì ë¸Œë¼ìš°ì € (ì„œë¹„ìŠ¤ ì›Œì»¤)  |
| **íŠ¸ë¦¬ê±°**    | ë¬¸ì„œ ì¡°íšŒ/ë‹¤ìš´ë¡œë“œ ìˆ˜ ë‹¬ì„±     |
| **ì•Œë¦¼ í˜•ì‹** | ë¸Œë¼ìš°ì € OS ì•Œë¦¼ (ë°°ë„ˆ/í† ìŠ¤íŠ¸) |
| **ë™ì‘ í™˜ê²½** | PC, ëª¨ë°”ì¼(í™ˆí™”ë©´ ì¶”ê°€), PWA   |

---

## êµ¬ì¡° ë° ë™ì‘ ì›ë¦¬

```
ì‚¬ìš©ì í–‰ë™ (ì¡°íšŒ/ë‹¤ìš´ë¡œë“œ)
        â†“
Express ë°±ì—”ë“œ ê°ì§€
        â†“
ì¡°ê±´ í™•ì¸ (10íšŒ, 100íšŒ ë“±)
        â†“
ì„œë²„ì—ì„œ web-push ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ í‘¸ì‹œ ë©”ì‹œì§€ ë°œì†¡
        â†“
í‘¸ì‹œ ì„œë¹„ìŠ¤ (FCM, APNs ë“±) ê²½ìœ 
        â†“
ì‚¬ìš©ì ë¸Œë¼ìš°ì € ìˆ˜ì‹ 
        â†“
ì„œë¹„ìŠ¤ ì›Œì»¤ í™œì„±í™”
        â†“
Notification APIë¡œ í™”ë©´ì— ì•Œë¦¼ í‘œì‹œ
```

### í•µì‹¬ ê°œë…

1. **VAPID (Voluntary Application Server Identification)**

   - ì„œë²„ê°€ í‘¸ì‹œ ì„œë¹„ìŠ¤ì— ìì‹ ì„ ì¸ì¦í•˜ê¸° ìœ„í•œ ê³µê°œ/ê°œì¸ í‚¤ ìŒ
   - ë³´ì•ˆ ëª©ì 

2. **PushSubscription**

   - ì‚¬ìš©ì ë¸Œë¼ìš°ì €ì˜ ê³ ìœ í•œ êµ¬ë… ì •ë³´
   - ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ì•¼ í•¨

3. **ì„œë¹„ìŠ¤ ì›Œì»¤ (Service Worker)**
   - ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
   - í‘¸ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì•Œë¦¼ í‘œì‹œ

---

## 1ë‹¨ê³„: í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

### ë°±ì—”ë“œ

```bash
npm install web-push
```

### í•„ìš”í•œ ê²½ìš°

```bash
# í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ (ì„ íƒ)
npm install dotenv
```

### í™•ì¸

```bash
npm list web-push
```

---

## 2ë‹¨ê³„: VAPID í‚¤ ì„¤ì •

VAPID í‚¤ëŠ” ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ì˜ ì¸ì¦ì„ ìœ„í•œ ì•”í˜¸í™” í‚¤ ìŒì…ë‹ˆë‹¤.

### í”„ë¡œì íŠ¸ ì „ìš© VAPID í‚¤ (í…ŒìŠ¤íŠ¸ìš©)

**Public Key (ê³µê°œ í‚¤):**
`BBE0_v9v_L5Y8kU6q8X7z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O3N2M1L0K9J8I7H6G5F4E3D2C1B0A`

**Private Key (ê°œì¸ í‚¤):**
`u7_X8z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O`

### ì €ì¥ ìœ„ì¹˜

**.env** íŒŒì¼ì— ì €ì¥:

```env
# .env (ì„œë²„ ë£¨íŠ¸)
VAPID_PUBLIC_KEY=BBE0_v9v_L5Y8kU6q8X7z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O3N2M1L0K9J8I7H6G5F4E3D2C1B0A
VAPID_PRIVATE_KEY=u7_X8z9M6K5J4I3H2G1F0E9D8C7B6A5Z4Y3X2W1V0U9T8S7R6Q5P4O
VAPID_SUBJECT=mailto:admin@example.com
```

### ì£¼ì˜ì‚¬í•­

âš ï¸ **Private KeyëŠ” ì ˆëŒ€ ê³µê°œí•˜ì§€ ë§ˆì„¸ìš”!**

- ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œí•˜ì§€ ë§ê¸°
- .gitignoreì— .env ì¶”ê°€í•˜ê¸°

```gitignore
# .gitignore
.env
.env.local
```

---

## 3ë‹¨ê³„: ë°±ì—”ë“œ êµ¬í˜„ (Express)

### 3.1 ì›¹ í‘¸ì‹œ ì„¤ì •

**src/server.js** (ë˜ëŠ” main.js)

```javascript
import webpush from 'web-push';
import dotenv from 'dotenv';

dotenv.config();

// VAPID í‚¤ ì„¤ì •
webpush.setVapidDetails(process.env.VAPID_SUBJECT, process.env.VAPID_PUBLIC_KEY, process.env.VAPID_PRIVATE_KEY);

export default webpush;
```

### 3.2 êµ¬ë… ì €ì¥ ì—”ë“œí¬ì¸íŠ¸

**src/routes/push.js**

```javascript
import express from 'express';
import webpush from '../server.js'; // ìœ„ì—ì„œ ì„¤ì •í•œ ëª¨ë“ˆ
import { savePushSubscription, getPushSubscription } from '../models/pushModel.js';

const router = express.Router();

/**
 * POST /api/push/subscribe
 * í´ë¼ì´ì–¸íŠ¸ì—ì„œ êµ¬ë… ì •ë³´ë¥¼ ë°›ì•„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
 */
router.post('/subscribe', async (req, res) => {
  try {
    const { subscription, userId } = req.body;

    if (!subscription || !userId) {
      return res.status(400).json({ error: 'êµ¬ë… ì •ë³´ ë˜ëŠ” ì‚¬ìš©ì ID ëˆ„ë½' });
    }

    // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    await savePushSubscription(userId, subscription);

    res.status(201).json({ message: 'êµ¬ë… ì„±ê³µ' });
  } catch (error) {
    console.error('êµ¬ë… ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

/**
 * POST /api/push/send
 * íŠ¹ì • ì‚¬ìš©ìì—ê²Œ í‘¸ì‹œ ë©”ì‹œì§€ ë°œì†¡
 * (ë‚´ë¶€ìš© - ì¡°íšŒ/ë‹¤ìš´ë¡œë“œ ê°ì§€ ì‹œ í˜¸ì¶œ)
 */
router.post('/send', async (req, res) => {
  try {
    const { userId, title, body } = req.body;

    if (!userId || !title || !body) {
      return res.status(400).json({ error: 'í•„ìˆ˜ ì •ë³´ ëˆ„ë½' });
    }

    // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ êµ¬ë… ì •ë³´ ì¡°íšŒ
    const subscription = await getPushSubscription(userId);

    if (!subscription) {
      return res.status(404).json({ error: 'í•´ë‹¹ ì‚¬ìš©ìì˜ êµ¬ë… ì •ë³´ ì—†ìŒ' });
    }

    // í‘¸ì‹œ ë©”ì‹œì§€ í˜ì´ë¡œë“œ
    const payload = JSON.stringify({
      title,
      body,
      icon: '/images/icon-192.png', // í”„ë¡œì íŠ¸ì˜ ì•„ì´ì½˜ ê²½ë¡œ
      badge: '/images/badge-72.png',
    });

    // ì›¹ í‘¸ì‹œ ë°œì†¡
    await webpush.sendNotification(subscription, payload);

    res.status(200).json({ message: 'í‘¸ì‹œ ë°œì†¡ ì„±ê³µ' });
  } catch (error) {
    console.error('í‘¸ì‹œ ë°œì†¡ ì‹¤íŒ¨:', error);

    // 410 Gone: êµ¬ë…ì´ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ê±°ë¶€í–ˆê±°ë‚˜ ë¸Œë¼ìš°ì € ì´ˆê¸°í™”)
    if (error.statusCode === 410) {
      await deletePushSubscription(userId); // DBì—ì„œ ì œê±°
      return res.status(410).json({ error: 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    res.status(500).json({ error: 'í‘¸ì‹œ ë°œì†¡ ì‹¤íŒ¨' });
  }
});

export default router;
```

### 3.3 íŒ”ë¡œìš° ì•Œë¦¼ íŠ¸ë¦¬ê±° ì˜ˆì‹œ

ëˆ„êµ°ê°€ ë‚˜ë¥¼ êµ¬ë…í–ˆì„ ë•Œ(`subscriptions` í…Œì´ë¸”ì— ë°ì´í„° ì¶”ê°€ ì‹œ) ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ë¡œì§ì…ë‹ˆë‹¤.

```javascript
/**
 * ëˆ„êµ°ê°€ ë‚˜ë¥¼ íŒ”ë¡œìš°í–ˆì„ ë•Œ í˜¸ì¶œ
 */
export async function handleNewFollower(followerId, followingId) {
  try {
    // 1. íŒ”ë¡œì›Œì˜ ì´ë¦„ ì¡°íšŒ (users í…Œì´ë¸”)
    const follower = await db.users.findUnique({ where: { id: followerId } });

    // 2. íŒ”ë¡œìš° ëŒ€ìƒ(ë‚˜)ì˜ í‘¸ì‹œ êµ¬ë… ì •ë³´ ì¡°íšŒ (push_subscriptions í…Œì´ë¸”)
    const subscriptions = await db.push_subscriptions.findMany({
      where: { user_id: followingId },
    });

    // 3. ì•Œë¦¼ ë©”ì‹œì§€ êµ¬ì„±
    const payload = JSON.stringify({
      title: 'ìƒˆë¡œìš´ íŒ”ë¡œì›Œ! ğŸ‰',
      body: `${follower.username}ë‹˜ì´ ë‹¹ì‹ ì„ êµ¬ë…í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤!`,
      icon: '/icons/icon-192x192.png',
      data: { url: `/profile/${follower.username}` },
    });

    // 4. ì›¹ í‘¸ì‹œ ë°œì†¡
    subscriptions.forEach((sub) => {
      webpush
        .sendNotification(
          {
            endpoint: sub.endpoint,
            keys: { p256dh: sub.p256dh, auth: sub.auth },
          },
          payload,
        )
        .catch((err) => {
          if (err.statusCode === 410) {
            // ë§Œë£Œëœ êµ¬ë… ì •ë³´ ì‚­ì œ
            db.push_subscriptions.delete({ where: { id: sub.id } });
          }
        });
    });
  } catch (error) {
    console.error('íŒ”ë¡œìš° ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:', error);
  }
}
```

### 3.4 Express ë¼ìš°í„° ë“±ë¡

**src/server.js**

```javascript
import express from 'express';
import pushRoutes from './routes/push.js';

const app = express();

app.use(express.json());
app.use('/api/push', pushRoutes);

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

---

## 4ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ (BEM ìŠ¤íƒ€ì¼)

UI ì»´í¬ë„ŒíŠ¸ëŠ” í”„ë¡œì íŠ¸ ìŠ¤íƒ€ì¼ ê°€ì´ë“œì— ë”°ë¼ SCSSì™€ BEM ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 4.1 ì•Œë¦¼ í† ê¸€ ì»´í¬ë„ŒíŠ¸

**client/src/components/NotificationToggle.jsx**

```javascript
// BEM êµ¬ì¡° ì˜ˆì‹œ:
// .notification-toggle
//   &__label
//   &__switch
//     &--active

return (
  <div className="notification-toggle">
    <span className="notification-toggle__label">ì‹¤ì‹œê°„ ì•Œë¦¼ ë°›ê¸°</span>
    <button
      className={`notification-toggle__switch ${isSubscribed ? 'notification-toggle__switch--active' : ''}`}
      onClick={handleToggle}
    >
      <div className="notification-toggle__slider" />
    </button>
  </div>
);
```

### 4.2 ê³µê°œ í‚¤ ê°€ì ¸ì˜¤ê¸°

**src/config/push.js**

```javascript
// ë°±ì—”ë“œì—ì„œ ê³µê°œ í‚¤ë¥¼ ì „ë‹¬ë°›ê±°ë‚˜ .envì—ì„œ ë¡œë“œ
export const VAPID_PUBLIC_KEY = import.meta.env.VITE_VAPID_PUBLIC_KEY;
```

**.env.local**

```env
VITE_VAPID_PUBLIC_KEY=BD1...ê¸°_ê¸´_ë¬¸ìì—´
```

### 4.2 í‘¸ì‹œ êµ¬ë… ê´€ë¦¬

**src/utils/pushSubscription.js**

```javascript
import { VAPID_PUBLIC_KEY } from '../config/push';

/**
 * ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ë° í‘¸ì‹œ êµ¬ë…
 */
export async function registerAndSubscribeToPush(userId) {
  try {
    // 1. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
      console.warn('ì´ ë¸Œë¼ìš°ì €ëŠ” ì›¹ í‘¸ì‹œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return false;
    }

    // 2. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      return false;
    }

    // 3. ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
    const registration = await navigator.serviceWorker.register('/service-worker.js', {
      scope: '/',
    });
    console.log('âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', registration);

    // 4. í‘¸ì‹œ êµ¬ë…
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
    });

    console.log('âœ… í‘¸ì‹œ êµ¬ë… ì„±ê³µ:', subscription);

    // 5. ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
    await savePushSubscriptionToServer(userId, subscription);

    return true;
  } catch (error) {
    console.error('âŒ í‘¸ì‹œ êµ¬ë… ì‹¤íŒ¨:', error);
    return false;
  }
}

/**
 * êµ¬ë… ì •ë³´ë¥¼ ì„œë²„ì— ì €ì¥
 */
async function savePushSubscriptionToServer(userId, subscription) {
  try {
    const response = await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        userId,
        subscription: subscription.toJSON(),
      }),
    });

    if (!response.ok) {
      throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
    }

    console.log('âœ… ì„œë²„ì— êµ¬ë… ì •ë³´ ì €ì¥ ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ êµ¬ë… ì •ë³´ ì „ì†¡ ì‹¤íŒ¨:', error);
    throw error;
  }
}

/**
 * Base64 ë¬¸ìì—´ì„ Uint8Arrayë¡œ ë³€í™˜
 * (VAPID ê³µê°œ í‚¤ í˜•ì‹ ë³€í™˜)
 */
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }

  return outputArray;
}
```

### 4.3 ì•± ì´ˆê¸°í™” ì‹œ êµ¬ë… í™œì„±í™”

**src/main.jsx** (ë˜ëŠ” App.jsx)

```javascript
import { registerAndSubscribeToPush } from './utils/pushSubscription';

// ë¡œê·¸ì¸ ì™„ë£Œ í›„ ë˜ëŠ” ì•± ì´ˆê¸°í™” ì‹œ í˜¸ì¶œ
export function initializePush() {
  const userId = getCurrentUserId(); // í˜„ì¬ ì‚¬ìš©ì ID ì¡°íšŒ

  registerAndSubscribeToPush(userId)
    .then((success) => {
      if (success) {
        console.log('ğŸ”” í‘¸ì‹œ ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch((error) => {
      console.error('í‘¸ì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    });
}

// ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ë˜ëŠ” ë¡œê·¸ì¸ í™”ë©´ì—ì„œ í˜¸ì¶œ
useEffect(() => {
  initializePush();
}, []);
```

---

## 5ë‹¨ê³„: ì„œë¹„ìŠ¤ ì›Œì»¤ êµ¬í˜„

### 5.1 ì„œë¹„ìŠ¤ ì›Œì»¤ íŒŒì¼ ìƒì„±

**public/service-worker.js**

```javascript
console.log('ğŸ“¦ Service Worker ë¡œë“œë¨');

// ì„œë¹„ìŠ¤ ì›Œì»¤ ì„¤ì¹˜
self.addEventListener('install', (event) => {
  console.log('ğŸ“¦ Service Worker ì„¤ì¹˜ ì¤‘...');
  // ì¦‰ì‹œ í™œì„±í™”
  self.skipWaiting();
});

// ì„œë¹„ìŠ¤ ì›Œì»¤ í™œì„±í™”
self.addEventListener('activate', (event) => {
  console.log('âœ… Service Worker í™œì„±í™”ë¨');
  // ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì œì–´
  self.clients.claim();
});

/**
 * í‘¸ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹  ì´ë²¤íŠ¸
 * ì„œë²„ì—ì„œ ë³´ë‚¸ í‘¸ì‹œ ë©”ì‹œì§€ë¥¼ ë°›ì•„ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
 */
self.addEventListener('push', (event) => {
  console.log('ğŸ“¬ í‘¸ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹ :', event);

  try {
    // ì„œë²„ì—ì„œ ë³´ë‚¸ ë°ì´í„° íŒŒì‹±
    const data = event.data ? event.data.json() : {};
    const { title = 'ì•Œë¦¼', body = '', icon = '', badge = '' } = data;

    const options = {
      body,
      icon, // ì•Œë¦¼ ì™¼ìª½ ì•„ì´ì½˜
      badge, // ì‘ì€ ë°°ì§€ ì•„ì´ì½˜
      vibrate: [200, 100, 200], // ì§„ë™ íŒ¨í„´ (ms)
      tag: 'notification', // ê°™ì€ íƒœê·¸ëŠ” ì¤‘ë³µ í‘œì‹œ ì•ˆ í•¨
      requireInteraction: false, // ì‚¬ìš©ìê°€ í´ë¦­í•´ì•¼ ë‹«í˜ (falseë©´ ìë™ ë‹«í˜)
    };

    // ì•Œë¦¼ í‘œì‹œ (ì„œë¹„ìŠ¤ ì›Œì»¤ ì¢…ë£Œ ì „ê¹Œì§€ ì™„ë£Œë˜ì–´ì•¼ í•¨)
    event.waitUntil(self.registration.showNotification(title, options));
  } catch (error) {
    console.error('âŒ í‘¸ì‹œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
  }
});

/**
 * ì•Œë¦¼ í´ë¦­ ì´ë²¤íŠ¸
 * ì‚¬ìš©ìê°€ ì•Œë¦¼ì„ í´ë¦­í–ˆì„ ë•Œì˜ ë™ì‘
 */
self.addEventListener('notificationclick', (event) => {
  console.log('ğŸ–±ï¸ ì•Œë¦¼ í´ë¦­ë¨:', event);

  // ì•Œë¦¼ ë‹«ê¸°
  event.notification.close();

  // ì•± í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” í¬ì»¤ìŠ¤
  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      // ì´ë¯¸ ì—´ë¦° íƒ­ì´ ìˆìœ¼ë©´ í¬ì»¤ìŠ¤
      for (const client of clientList) {
        if (client.url === '/' && 'focus' in client) {
          return client.focus();
        }
      }
      // ì—†ìœ¼ë©´ ìƒˆ íƒ­ ì—´ê¸°
      if (clients.openWindow) {
        return clients.openWindow('/');
      }
    }),
  );
});

/**
 * ì•Œë¦¼ ë‹«ê¸° ì´ë²¤íŠ¸ (ì„ íƒì‚¬í•­)
 * ì‚¬ìš©ìê°€ X ë²„íŠ¼ìœ¼ë¡œ ì•Œë¦¼ì„ ë‹«ì•˜ì„ ë•Œ
 */
self.addEventListener('notificationclose', (event) => {
  console.log('âŒ ì•Œë¦¼ ë‹«í˜:', event);
  // í•„ìš”í•˜ë©´ ë¶„ì„ ì „ì†¡ ë“±ì˜ ë¡œì§ ì¶”ê°€
});
```

### 5.2 ê²½ë¡œ í™•ì¸

ì„œë¹„ìŠ¤ ì›Œì»¤ëŠ” `public/` í´ë”ì˜ ë£¨íŠ¸ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤:

```
project/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ service-worker.js  âœ… ì—¬ê¸°
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ images/
â”œâ”€â”€ src/
â”œâ”€â”€ package.json
â””â”€â”€ vite.config.js
```

---

## 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸

### 6.1 ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

#### 1ë‹¨ê³„: ì„œë²„ ì‹œì‘

```bash
npm run dev:server
# ë˜ëŠ” êµ¬ì²´ì ì¸ ëª…ë ¹ì–´
node src/server.js
```

#### 2ë‹¨ê³„: Vite ê°œë°œ ì„œë²„ ì‹œì‘

```bash
npm run dev
```

#### 3ë‹¨ê³„: ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸

1. `http://localhost:5173` (Vite í¬íŠ¸) ë˜ëŠ” í•´ë‹¹ í¬íŠ¸ ì ‘ì†
2. ì½˜ì†”ì—ì„œ í™•ì¸:
   ```
   âœ… Service Worker ë“±ë¡ ì„±ê³µ
   âœ… í‘¸ì‹œ êµ¬ë… ì„±ê³µ
   âœ… ì„œë²„ì— êµ¬ë… ì •ë³´ ì €ì¥ ì™„ë£Œ
   ```

### 6.2 í‘¸ì‹œ ë©”ì‹œì§€ ë°œì†¡ í…ŒìŠ¤íŠ¸

#### ì˜µì…˜ A: cURL ì‚¬ìš©

```bash
curl -X POST http://localhost:3000/api/push/send \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user123",
    "title": "í…ŒìŠ¤íŠ¸ ì œëª©",
    "body": "í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤!"
  }'
```

#### ì˜µì…˜ B: Postman ì‚¬ìš©

1. POST ìš”ì²­ URL: `http://localhost:3000/api/push/send`
2. Body (JSON):
   ```json
   {
     "userId": "user123",
     "title": "ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰",
     "body": "ë¬¸ì„œ ì¡°íšŒê°€ 10íšŒì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!"
   }
   ```
3. Send í´ë¦­

#### ì˜µì…˜ C: ì½”ë“œì—ì„œ ì§ì ‘ í˜¸ì¶œ

```javascript
// ê°œë°œì ë„êµ¬ ì½˜ì†”ì—ì„œ
fetch('/api/push/send', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: 'user123',
    title: 'í…ŒìŠ¤íŠ¸',
    body: 'ì›¹ í‘¸ì‹œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤!',
  }),
})
  .then((r) => r.json())
  .then(console.log);
```

### 6.3 ì˜ˆìƒ ê²°ê³¼

ì„±ê³µ ì‹œ í™”ë©´ì˜ ìš°ì¸¡ ìƒë‹¨(ë˜ëŠ” ë¸Œë¼ìš°ì €ë³„ ê¸°ë³¸ ìœ„ì¹˜)ì— ì•Œë¦¼ì´ ë‚˜íƒ€ë‚˜ì•¼ í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í…ŒìŠ¤íŠ¸               â”œâ”€ X
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì›¹ í‘¸ì‹œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤!â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Q1: "Service Worker ë“±ë¡ ì‹¤íŒ¨"

**ì›ì¸**: ë³´ì•ˆ ì •ì±… ë˜ëŠ” ê²½ë¡œ ë¬¸ì œ

**í•´ê²°ì±…**:

1. ê°œë°œ ëª¨ë“œ: localhost ì‚¬ìš©
2. í”„ë¡œë•ì…˜: HTTPS í•„ìˆ˜
3. ê²½ë¡œ í™•ì¸: `public/service-worker.js`ê°€ ì¡´ì¬í•˜ëŠ”ê°€?

```javascript
// ê²½ë¡œ ëª…ì‹œ
const registration = await navigator.serviceWorker.register('/service-worker.js');
```

### Q2: "ì›¹ í‘¸ì‹œ êµ¬ë… ì‹¤íŒ¨"

**ì›ì¸**: VAPID ê³µê°œ í‚¤ ì˜¤ë¥˜ ë˜ëŠ” í˜•ì‹ ë¬¸ì œ

**í•´ê²°ì±…**:

1. `.env.local` íŒŒì¼ í™•ì¸
   ```env
   VITE_VAPID_PUBLIC_KEY=ì •í™•í•œ_í‚¤ê°’
   ```
2. Vite ì„œë²„ ì¬ì‹œì‘
3. ìºì‹œ ì‚­ì œ: F12 â†’ Application â†’ Service Workers â†’ Unregister

### Q3: "í‘¸ì‹œëŠ” êµ¬ë…í–ˆëŠ”ë° ë©”ì‹œì§€ê°€ ì•ˆ ì˜´"

**ì›ì¸**: êµ¬ë… ì •ë³´ê°€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŒ ë˜ëŠ” ì˜ëª»ëœ userId

**í™•ì¸ ì‚¬í•­**:

1. ë„¤íŠ¸ì›Œí¬ íƒ­: POST `/api/push/subscribe`ê°€ 200 ì‘ë‹µì¸ê°€?
2. ì„œë²„ ë¡œê·¸: "êµ¬ë… ì •ë³´ ì €ì¥ ì™„ë£Œ"ê°€ ë‚˜ì˜¤ëŠ”ê°€?
3. ë°ì´í„°ë² ì´ìŠ¤: í•´ë‹¹ userIdì˜ êµ¬ë… ì •ë³´ê°€ ìˆëŠ”ê°€?

### Q4: "410 Gone ì—ëŸ¬"

**ì›ì¸**: ì‚¬ìš©ìê°€ êµ¬ë…ì„ ì·¨ì†Œí–ˆê±°ë‚˜ ë¸Œë¼ìš°ì €ê°€ ì´ˆê¸°í™”ë¨

**í•´ê²°ì±…**:

1. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ êµ¬ë… ì •ë³´ ì‚­ì œ (ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨)
2. ì‚¬ìš©ìê°€ ë‹¤ì‹œ êµ¬ë…í•˜ë„ë¡ ìœ ë„

### Q5: "HTTPSê°€ ì—†ëŠ” í”„ë¡œë•ì…˜ í™˜ê²½"

**ì„ì‹œ í•´ê²°ì±…** (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©):

```javascript
// public/service-worker.js
// localhostì™€ 127.0.0.1ì—ì„œë§Œ í…ŒìŠ¤íŠ¸
if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
  console.warn('Service WorkerëŠ” HTTPS í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}
```

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

í”„ë¡œì íŠ¸ì— ì›¹ í‘¸ì‹œë¥¼ ì¶”ê°€í•  ë•Œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] `npm install web-push` ì™„ë£Œ
- [ ] `.env` íŒŒì¼ì— VAPID í‚¤ ì €ì¥
- [ ] `.gitignore`ì— `.env` ì¶”ê°€
- [ ] ë°±ì—”ë“œ: `src/routes/push.js` êµ¬í˜„
- [ ] ë°±ì—”ë“œ: Express ë¼ìš°í„° ë“±ë¡
- [ ] í”„ë¡ íŠ¸ì—”ë“œ: `src/utils/pushSubscription.js` êµ¬í˜„
- [ ] í”„ë¡ íŠ¸ì—”ë“œ: `public/service-worker.js` ìƒì„±
- [ ] í”„ë¡ íŠ¸ì—”ë“œ: `.env.local` íŒŒì¼ì— ê³µê°œ í‚¤ ì €ì¥
- [ ] ì´ˆê¸°í™” ì½”ë“œ: `initializePush()` í˜¸ì¶œ ì¶”ê°€
- [ ] ì¡°íšŒ/ë‹¤ìš´ë¡œë“œ ì¶”ì : `trackDocumentView()`, `trackDocumentDownload()` í˜¸ì¶œ
- [ ] í…ŒìŠ¤íŠ¸: cURL/Postmanìœ¼ë¡œ í‘¸ì‹œ ë©”ì‹œì§€ ë°œì†¡ í…ŒìŠ¤íŠ¸
- [ ] ì½˜ì†” ë¡œê·¸ í™•ì¸: ì˜¤ë¥˜ ì—†ëŠ”ê°€?

---

## ë‹¤ìŒ ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

í˜„ í”„ë¡œì íŠ¸ì˜ ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°ì™€ ì—°ë™ë˜ëŠ” í‘¸ì‹œ ì•Œë¦¼ ì „ìš© í…Œì´ë¸”ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

### ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡° (ì°¸ê³ )

- `users`: ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ (id: uuid)
- `subscriptions`: íŒ”ë¡œìš° ê´€ê³„ (follower_id, following_id: uuid)
- `nodes`: ë¬¸ì„œ/ë…¸ë“œ ì •ë³´ (author_id: uuid)
- `node_interactions`: ì¡°íšŒ/ë‹¤ìš´ë¡œë“œ ê¸°ë¡ (user_id: uuid)

### ì‹ ê·œ ì¶”ê°€ í…Œì´ë¸”: `push_subscriptions`

ë¸Œë¼ìš°ì €ë³„ í‘¸ì‹œ í† í° ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê¸°ê¸°(PC, ëª¨ë°”ì¼ ë“±)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìë‹¹ ì—¬ëŸ¬ ë ˆì½”ë“œë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
CREATE TABLE push_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL UNIQUE,
  p256dh TEXT NOT NULL,
  auth TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì‚¬ìš©ì ì•„ì´ë””ë¡œ ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX idx_push_subs_user_id ON push_subscriptions(user_id);
```

---

## ì°¸ê³  ìë£Œ

- [MDN - Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [MDN - Push API](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
- [web-push npm ë¬¸ì„œ](https://github.com/web-push-libs/web-push)
- [Google - Web Push Notifications](https://developers.google.com/web/fundamentals/push-notifications)

---

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ë§ˆì§€ë§‰ ìˆ˜ì •**: 2026ë…„ 1ì›” 5ì¼  
**ì‘ì„±ì**: AI Assistant
